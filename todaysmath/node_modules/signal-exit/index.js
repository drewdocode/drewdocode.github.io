function unload(){loaded&&(loaded=!1,signals.forEach(function(e){try{process.removeListener(e,sigListeners[e])}catch(e){}}),process.emit=originalProcessEmit,process.reallyExit=originalProcessReallyExit,emitter.count-=1)}function emit(e,t,i){emitter.emitted[e]||(emitter.emitted[e]=!0,emitter.emit(e,t,i))}function load(){loaded||(loaded=!0,emitter.count+=1,signals=signals.filter(function(e){try{return process.on(e,sigListeners[e]),!0}catch(e){return!1}}),process.emit=processEmit,process.reallyExit=processReallyExit)}function processReallyExit(e){process.exitCode=e||0,emit("exit",process.exitCode,null),emit("afterexit",process.exitCode,null),originalProcessReallyExit.call(process,process.exitCode)}function processEmit(e,t){if("exit"===e){void 0!==t&&(process.exitCode=t);var i=originalProcessEmit.apply(this,arguments);return emit("exit",process.exitCode,null),emit("afterexit",process.exitCode,null),i}return originalProcessEmit.apply(this,arguments)}var assert=require("assert"),signals=require("./signals.js"),EE=require("events");"function"!=typeof EE&&(EE=EE.EventEmitter);var emitter;process.__signal_exit_emitter__?emitter=process.__signal_exit_emitter__:(emitter=process.__signal_exit_emitter__=new EE,emitter.count=0,emitter.emitted={}),emitter.infinite||(emitter.setMaxListeners(1/0),emitter.infinite=!0),module.exports=function(e,t){assert.equal(typeof e,"function","a callback must be provided for exit handler"),!1===loaded&&load();var i="exit";t&&t.alwaysLast&&(i="afterexit");var s=function(){emitter.removeListener(i,e),0===emitter.listeners("exit").length&&0===emitter.listeners("afterexit").length&&unload()};return emitter.on(i,e),s},module.exports.unload=unload;var sigListeners={};signals.forEach(function(e){sigListeners[e]=function(){process.listeners(e).length===emitter.count&&(unload(),emit("exit",null,e),emit("afterexit",null,e),process.kill(process.pid,e))}}),module.exports.signals=function(){return signals},module.exports.load=load;var loaded=!1,originalProcessReallyExit=process.reallyExit,originalProcessEmit=process.emit;