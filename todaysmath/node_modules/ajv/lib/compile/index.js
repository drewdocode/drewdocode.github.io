function compile(e,r,o,t){function a(){var e=b.validate,r=e.apply(null,arguments);return a.errors=e.errors,r}function i(e,o,t,a){var i=!o||o&&o.schema==e;if(o.schema!=r.schema)return compile.call(m,e,o,t,a);var n=!0===e.$async,s=validateGenerator({isTop:!0,schema:e,isRoot:i,baseId:a,root:o,schemaPath:"",errSchemaPath:"#",errorPath:'""',MissingRefError:errorClasses.MissingRef,RULES:E,validate:validateGenerator,util:util,resolve:resolve,resolveRef:l,usePattern:f,useDefault:d,useCustomRule:v,opts:h,formats:q,logger:m.logger,self:m});s=vars(p,refValCode)+vars(y,patternCode)+vars(V,defaultCode)+vars(S,customRuleCode)+s,h.processCode&&(s=h.processCode(s));var c;try{c=new Function("self","RULES","formats","root","refVal","defaults","customRules","co","equal","ucs2length","ValidationError",s)(m,E,q,r,p,V,S,co,equal,ucs2length,ValidationError),p[0]=c}catch(e){throw m.logger.error("Error compiling schema, function code:",s),e}return c.schema=e,c.errors=null,c.refs=g,c.refVal=p,c.root=i?c:o,n&&(c.$async=!0),!0===h.sourceCode&&(c.source={code:s,patterns:y,defaults:V}),c}function l(e,t,a){t=resolve.url(e,t);var l,f,d=g[t];if(void 0!==d)return l=p[d],f="refVal["+d+"]",u(l,f);if(!a&&r.refs){var v=r.refs[t];if(void 0!==v)return l=r.refVal[v],f=n(t,l),u(l,f)}f=n(t);var y=resolve.call(m,i,r,t);if(void 0===y){var C=o&&o[t];C&&(y=resolve.inlineRef(C,h.inlineRefs)?C:compile.call(m,C,r,o,e))}if(void 0!==y)return c(t,y),u(y,f);s(t)}function n(e,r){var o=p.length;return p[o]=r,g[e]=o,"refVal"+o}function s(e){delete g[e]}function c(e,r){var o=g[e];p[o]=r}function u(e,r){return"object"==typeof e||"boolean"==typeof e?{code:r,schema:e,inline:!0}:{code:r,$async:e&&e.$async}}function f(e){var r=C[e];return void 0===r&&(r=C[e]=y.length,y[r]=e),"pattern"+r}function d(e){switch(typeof e){case"boolean":case"number":return""+e;case"string":return util.toQuotedString(e);case"object":if(null===e)return"null";var r=stableStringify(e),o=R[r];return void 0===o&&(o=R[r]=V.length,V[o]=e),"default"+o}}function v(e,r,o,t){var a=e.definition.validateSchema;if(a&&!1!==m._opts.validateSchema){if(!a(r)){var i="keyword schema is invalid: "+m.errorsText(a.errors);if("log"!=m._opts.validateSchema)throw new Error(i);m.logger.error(i)}}var l,n=e.definition.compile,s=e.definition.inline,c=e.definition.macro;if(n)l=n.call(m,r,o,t);else if(c)l=c.call(m,r,o,t),!1!==h.validateSchema&&m.validateSchema(l,!0);else if(s)l=s.call(m,t,e.keyword,r,o);else if(!(l=e.definition.validate))return;if(void 0===l)throw new Error('custom keyword "'+e.keyword+'"failed to compile');var u=S.length;return S[u]=l,{code:"customRule"+u,validate:l}}var m=this,h=this._opts,p=[void 0],g={},y=[],C={},V=[],R={},S=[];r=r||{schema:e,refVal:p,refs:g};var w=checkCompiling.call(this,e,r,t),b=this._compilations[w.index];if(w.compiling)return b.callValidate=a;var q=this._formats,E=this.RULES;try{var _=i(e,r,o,t);b.validate=_;var x=b.callValidate;return x&&(x.schema=_.schema,x.errors=null,x.refs=_.refs,x.refVal=_.refVal,x.root=_.root,x.$async=_.$async,h.sourceCode&&(x.source=_.source)),_}finally{endCompiling.call(this,e,r,t)}}function checkCompiling(e,r,o){var t=compIndex.call(this,e,r,o);return t>=0?{index:t,compiling:!0}:(t=this._compilations.length,this._compilations[t]={schema:e,root:r,baseId:o},{index:t,compiling:!1})}function endCompiling(e,r,o){var t=compIndex.call(this,e,r,o);t>=0&&this._compilations.splice(t,1)}function compIndex(e,r,o){for(var t=0;t<this._compilations.length;t++){var a=this._compilations[t];if(a.schema==e&&a.root==r&&a.baseId==o)return t}return-1}function patternCode(e,r){return"var pattern"+e+" = new RegExp("+util.toQuotedString(r[e])+");"}function defaultCode(e){return"var default"+e+" = defaults["+e+"];"}function refValCode(e,r){return void 0===r[e]?"":"var refVal"+e+" = refVal["+e+"];"}function customRuleCode(e){return"var customRule"+e+" = customRules["+e+"];"}function vars(e,r){if(!e.length)return"";for(var o="",t=0;t<e.length;t++)o+=r(t,e);return o}var resolve=require("./resolve"),util=require("./util"),errorClasses=require("./error_classes"),stableStringify=require("fast-json-stable-stringify"),validateGenerator=require("../dotjs/validate"),co=require("co"),ucs2length=util.ucs2length,equal=require("fast-deep-equal"),ValidationError=errorClasses.Validation;module.exports=compile;