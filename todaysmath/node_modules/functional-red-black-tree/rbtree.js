"use strict";function RBNode(t,e,r,o,i,l){this._color=t,this.key=e,this.value=r,this.left=o,this.right=i,this._count=l}function cloneNode(t){return new RBNode(t._color,t.key,t.value,t.left,t.right,t._count)}function repaint(t,e){return new RBNode(t,e.key,e.value,e.left,e.right,e._count)}function recount(t){t._count=1+(t.left?t.left._count:0)+(t.right?t.right._count:0)}function RedBlackTree(t,e){this._compare=t,this.root=e}function doVisitFull(t,e){if(e.left){var r=doVisitFull(t,e.left);if(r)return r}var r=t(e.key,e.value);return r||(e.right?doVisitFull(t,e.right):void 0)}function doVisitHalf(t,e,r,o){if(e(t,o.key)<=0){if(o.left){var i=doVisitHalf(t,e,r,o.left);if(i)return i}var i=r(o.key,o.value);if(i)return i}if(o.right)return doVisitHalf(t,e,r,o.right)}function doVisit(t,e,r,o,i){var l,n=r(t,i.key),f=r(e,i.key);if(n<=0){if(i.left&&(l=doVisit(t,e,r,o,i.left)))return l;if(f>0&&(l=o(i.key,i.value)))return l}if(f>0&&i.right)return doVisit(t,e,r,o,i.right)}function RedBlackTreeIterator(t,e){this.tree=t,this._stack=e}function swapNode(t,e){t.key=e.key,t.value=e.value,t.left=e.left,t.right=e.right,t._color=e._color,t._count=e._count}function fixDoubleBlack(t){for(var e,r,o,i,l=t.length-1;l>=0;--l){if(e=t[l],0===l)return void(e._color=BLACK);if(r=t[l-1],r.left===e){if(o=r.right,o.right&&o.right._color===RED){if(o=r.right=cloneNode(o),i=o.right=cloneNode(o.right),r.right=o.left,o.left=r,o.right=i,o._color=r._color,e._color=BLACK,r._color=BLACK,i._color=BLACK,recount(r),recount(o),l>1){var n=t[l-2];n.left===r?n.left=o:n.right=o}return void(t[l-1]=o)}if(o.left&&o.left._color===RED){if(o=r.right=cloneNode(o),i=o.left=cloneNode(o.left),r.right=i.left,o.left=i.right,i.left=r,i.right=o,i._color=r._color,r._color=BLACK,o._color=BLACK,e._color=BLACK,recount(r),recount(o),recount(i),l>1){var n=t[l-2];n.left===r?n.left=i:n.right=i}return void(t[l-1]=i)}if(o._color===BLACK){if(r._color===RED)return r._color=BLACK,void(r.right=repaint(RED,o));r.right=repaint(RED,o);continue}if(o=cloneNode(o),r.right=o.left,o.left=r,o._color=r._color,r._color=RED,recount(r),recount(o),l>1){var n=t[l-2];n.left===r?n.left=o:n.right=o}t[l-1]=o,t[l]=r,l+1<t.length?t[l+1]=e:t.push(e),l+=2}else{if(o=r.left,o.left&&o.left._color===RED){if(o=r.left=cloneNode(o),i=o.left=cloneNode(o.left),r.left=o.right,o.right=r,o.left=i,o._color=r._color,e._color=BLACK,r._color=BLACK,i._color=BLACK,recount(r),recount(o),l>1){var n=t[l-2];n.right===r?n.right=o:n.left=o}return void(t[l-1]=o)}if(o.right&&o.right._color===RED){if(o=r.left=cloneNode(o),i=o.right=cloneNode(o.right),r.left=i.right,o.right=i.left,i.right=r,i.left=o,i._color=r._color,r._color=BLACK,o._color=BLACK,e._color=BLACK,recount(r),recount(o),recount(i),l>1){var n=t[l-2];n.right===r?n.right=i:n.left=i}return void(t[l-1]=i)}if(o._color===BLACK){if(r._color===RED)return r._color=BLACK,void(r.left=repaint(RED,o));r.left=repaint(RED,o);continue}if(o=cloneNode(o),r.left=o.right,o.right=r,o._color=r._color,r._color=RED,recount(r),recount(o),l>1){var n=t[l-2];n.right===r?n.right=o:n.left=o}t[l-1]=o,t[l]=r,l+1<t.length?t[l+1]=e:t.push(e),l+=2}}}function defaultCompare(t,e){return t<e?-1:t>e?1:0}function createRBTree(t){return new RedBlackTree(t||defaultCompare,null)}module.exports=createRBTree;var RED=0,BLACK=1,proto=RedBlackTree.prototype;Object.defineProperty(proto,"keys",{get:function(){var t=[];return this.forEach(function(e,r){t.push(e)}),t}}),Object.defineProperty(proto,"values",{get:function(){var t=[];return this.forEach(function(e,r){t.push(r)}),t}}),Object.defineProperty(proto,"length",{get:function(){return this.root?this.root._count:0}}),proto.insert=function(t,e){for(var r=this._compare,o=this.root,i=[],l=[];o;){var n=r(t,o.key);i.push(o),l.push(n),o=n<=0?o.left:o.right}i.push(new RBNode(RED,t,e,null,null,1));for(var f=i.length-2;f>=0;--f){var o=i[f];l[f]<=0?i[f]=new RBNode(o._color,o.key,o.value,i[f+1],o.right,o._count+1):i[f]=new RBNode(o._color,o.key,o.value,o.left,i[f+1],o._count+1)}for(var f=i.length-1;f>1;--f){var c=i[f-1],o=i[f];if(c._color===BLACK||o._color===BLACK)break;var h=i[f-2];if(h.left===c)if(c.left===o){var u=h.right;if(!u||u._color!==RED){if(h._color=RED,h.left=c.right,c._color=BLACK,c.right=h,i[f-2]=c,i[f-1]=o,recount(h),recount(c),f>=3){var a=i[f-3];a.left===h?a.left=c:a.right=c}break}c._color=BLACK,h.right=repaint(BLACK,u),h._color=RED,f-=1}else{var u=h.right;if(!u||u._color!==RED){if(c.right=o.left,h._color=RED,h.left=o.right,o._color=BLACK,o.left=c,o.right=h,i[f-2]=o,i[f-1]=c,recount(h),recount(c),recount(o),f>=3){var a=i[f-3];a.left===h?a.left=o:a.right=o}break}c._color=BLACK,h.right=repaint(BLACK,u),h._color=RED,f-=1}else if(c.right===o){var u=h.left;if(!u||u._color!==RED){if(h._color=RED,h.right=c.left,c._color=BLACK,c.left=h,i[f-2]=c,i[f-1]=o,recount(h),recount(c),f>=3){var a=i[f-3];a.right===h?a.right=c:a.left=c}break}c._color=BLACK,h.left=repaint(BLACK,u),h._color=RED,f-=1}else{var u=h.left;if(!u||u._color!==RED){if(c.left=o.right,h._color=RED,h.right=o.left,o._color=BLACK,o.right=c,o.left=h,i[f-2]=o,i[f-1]=c,recount(h),recount(c),recount(o),f>=3){var a=i[f-3];a.right===h?a.right=o:a.left=o}break}c._color=BLACK,h.left=repaint(BLACK,u),h._color=RED,f-=1}}return i[0]._color=BLACK,new RedBlackTree(r,i[0])},proto.forEach=function(t,e,r){if(this.root)switch(arguments.length){case 1:return doVisitFull(t,this.root);case 2:return doVisitHalf(e,this._compare,t,this.root);case 3:if(this._compare(e,r)>=0)return;return doVisit(e,r,this._compare,t,this.root)}},Object.defineProperty(proto,"begin",{get:function(){for(var t=[],e=this.root;e;)t.push(e),e=e.left;return new RedBlackTreeIterator(this,t)}}),Object.defineProperty(proto,"end",{get:function(){for(var t=[],e=this.root;e;)t.push(e),e=e.right;return new RedBlackTreeIterator(this,t)}}),proto.at=function(t){if(t<0)return new RedBlackTreeIterator(this,[]);for(var e=this.root,r=[];;){if(r.push(e),e.left){if(t<e.left._count){e=e.left;continue}t-=e.left._count}if(!t)return new RedBlackTreeIterator(this,r);if(t-=1,!e.right)break;if(t>=e.right._count)break;e=e.right}return new RedBlackTreeIterator(this,[])},proto.ge=function(t){for(var e=this._compare,r=this.root,o=[],i=0;r;){var l=e(t,r.key);o.push(r),l<=0&&(i=o.length),r=l<=0?r.left:r.right}return o.length=i,new RedBlackTreeIterator(this,o)},proto.gt=function(t){for(var e=this._compare,r=this.root,o=[],i=0;r;){var l=e(t,r.key);o.push(r),l<0&&(i=o.length),r=l<0?r.left:r.right}return o.length=i,new RedBlackTreeIterator(this,o)},proto.lt=function(t){for(var e=this._compare,r=this.root,o=[],i=0;r;){var l=e(t,r.key);o.push(r),l>0&&(i=o.length),r=l<=0?r.left:r.right}return o.length=i,new RedBlackTreeIterator(this,o)},proto.le=function(t){for(var e=this._compare,r=this.root,o=[],i=0;r;){var l=e(t,r.key);o.push(r),l>=0&&(i=o.length),r=l<0?r.left:r.right}return o.length=i,new RedBlackTreeIterator(this,o)},proto.find=function(t){for(var e=this._compare,r=this.root,o=[];r;){var i=e(t,r.key);if(o.push(r),0===i)return new RedBlackTreeIterator(this,o);r=i<=0?r.left:r.right}return new RedBlackTreeIterator(this,[])},proto.remove=function(t){var e=this.find(t);return e?e.remove():this},proto.get=function(t){for(var e=this._compare,r=this.root;r;){var o=e(t,r.key);if(0===o)return r.value;r=o<=0?r.left:r.right}};var iproto=RedBlackTreeIterator.prototype;Object.defineProperty(iproto,"valid",{get:function(){return this._stack.length>0}}),Object.defineProperty(iproto,"node",{get:function(){return this._stack.length>0?this._stack[this._stack.length-1]:null},enumerable:!0}),iproto.clone=function(){return new RedBlackTreeIterator(this.tree,this._stack.slice())},iproto.remove=function(){var t=this._stack;if(0===t.length)return this.tree;var e=new Array(t.length),r=t[t.length-1];e[e.length-1]=new RBNode(r._color,r.key,r.value,r.left,r.right,r._count);for(var o=t.length-2;o>=0;--o){var r=t[o];r.left===t[o+1]?e[o]=new RBNode(r._color,r.key,r.value,e[o+1],r.right,r._count):e[o]=new RBNode(r._color,r.key,r.value,r.left,e[o+1],r._count)}if(r=e[e.length-1],r.left&&r.right){var i=e.length;for(r=r.left;r.right;)e.push(r),r=r.right;var l=e[i-1];e.push(new RBNode(r._color,l.key,l.value,r.left,r.right,r._count)),e[i-1].key=r.key,e[i-1].value=r.value;for(var o=e.length-2;o>=i;--o)r=e[o],e[o]=new RBNode(r._color,r.key,r.value,r.left,e[o+1],r._count);e[i-1].left=e[i]}if(r=e[e.length-1],r._color===RED){var n=e[e.length-2];n.left===r?n.left=null:n.right===r&&(n.right=null),e.pop();for(var o=0;o<e.length;++o)e[o]._count--;return new RedBlackTree(this.tree._compare,e[0])}if(r.left||r.right){r.left?swapNode(r,r.left):r.right&&swapNode(r,r.right),r._color=BLACK;for(var o=0;o<e.length-1;++o)e[o]._count--;return new RedBlackTree(this.tree._compare,e[0])}if(1===e.length)return new RedBlackTree(this.tree._compare,null);for(var o=0;o<e.length;++o)e[o]._count--;var f=e[e.length-2];return fixDoubleBlack(e),f.left===r?f.left=null:f.right=null,new RedBlackTree(this.tree._compare,e[0])},Object.defineProperty(iproto,"key",{get:function(){if(this._stack.length>0)return this._stack[this._stack.length-1].key},enumerable:!0}),Object.defineProperty(iproto,"value",{get:function(){if(this._stack.length>0)return this._stack[this._stack.length-1].value},enumerable:!0}),Object.defineProperty(iproto,"index",{get:function(){var t=0,e=this._stack;if(0===e.length){var r=this.tree.root;return r?r._count:0}e[e.length-1].left&&(t=e[e.length-1].left._count);for(var o=e.length-2;o>=0;--o)e[o+1]===e[o].right&&(++t,e[o].left&&(t+=e[o].left._count));return t},enumerable:!0}),iproto.next=function(){var t=this._stack;if(0!==t.length){var e=t[t.length-1];if(e.right)for(e=e.right;e;)t.push(e),e=e.left;else for(t.pop();t.length>0&&t[t.length-1].right===e;)e=t[t.length-1],t.pop()}},Object.defineProperty(iproto,"hasNext",{get:function(){var t=this._stack;if(0===t.length)return!1;if(t[t.length-1].right)return!0;for(var e=t.length-1;e>0;--e)if(t[e-1].left===t[e])return!0;return!1}}),iproto.update=function(t){var e=this._stack;if(0===e.length)throw new Error("Can't update empty node!");var r=new Array(e.length),o=e[e.length-1];r[r.length-1]=new RBNode(o._color,o.key,t,o.left,o.right,o._count);for(var i=e.length-2;i>=0;--i)o=e[i],o.left===e[i+1]?r[i]=new RBNode(o._color,o.key,o.value,r[i+1],o.right,o._count):r[i]=new RBNode(o._color,o.key,o.value,o.left,r[i+1],o._count);return new RedBlackTree(this.tree._compare,r[0])},iproto.prev=function(){var t=this._stack;if(0!==t.length){var e=t[t.length-1];if(e.left)for(e=e.left;e;)t.push(e),e=e.right;else for(t.pop();t.length>0&&t[t.length-1].left===e;)e=t[t.length-1],t.pop()}},Object.defineProperty(iproto,"hasPrev",{get:function(){var t=this._stack;if(0===t.length)return!1;if(t[t.length-1].left)return!0;for(var e=t.length-1;e>0;--e)if(t[e-1].right===t[e])return!0;return!1}});