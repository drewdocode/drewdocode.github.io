"use strict";function printTree(e){return e?[COLORS[e._color],e.key,printTree(e.left),printTree(e.right)]:[]}function print(e){console.log(util.inspect(printTree(e.root),{depth:12}))}function checkTree(e,r){function t(a){if(!a)return[1,0];0===a._color?(r.assert(!a.left||1===a.left._color,"children of red node must be black"),r.assert(!a.right||1===a.right._color,"children of red node must be black")):r.equals(a._color,1,"node color must be red or black"),a.left&&r.assert(e._compare(a.left.key,a.key)<=0,"left tree order invariant"),a.right&&r.assert(e._compare(a.right.key,a.key)>=0,"right tree order invariant");var s=t(a.left),n=t(a.right);return r.equals(s[0],n[0],"number of black nodes along all paths to root must be constant"),r.equals(s[1]+n[1]+1,a._count,"item count consistency"),[s[0]+a._color,s[1]+n[1]+1]}if(e.root){r.equals(e.root._color,1,"root is black");var a=t(e.root);r.equals(a[1],e.length,"tree length")}}function compareIterators(e,r,t){t.equals(e.tree,r.tree,"iter trees"),t.equals(e.valid,r.valid,"iter validity"),r.valid&&(t.equals(e.node,r.node,"iter node"),t.equals(e.key,r.key,"iter key"),t.equals(e.value,r.value,"iter value"),t.equals(e.index,r.index,"iter index"))}var makeTree=require("../rbtree.js"),tape=require("tape"),util=require("util"),iota=require("iota-array"),COLORS=["r","b","bb"];tape("insert()",function(e){for(var r=makeTree(),t=r,a=[],s=20;s>=0;--s){var n=s,i=t.insert(n,!0);checkTree(t,e),checkTree(i,e),e.equals(t.length,a.length),a.push(n),t=i}for(var s=-20;s<0;++s){var n=s,i=t.insert(n,!0);checkTree(t,e),checkTree(i,e),a.sort(function(e,r){return e-r});var l=0;t.forEach(function(r,t){e.equals(r,a[l++])}),e.equals(l,a.length),a.push(n),t=i}for(var u=t.begin,s=-20,o=0;o<=40;++s,++o)e.equals(t.at(o).key,s,"checking at()"),e.equals(u.key,s,"checking iter"),e.equals(u.index,o,"checking index"),e.assert(u.valid,"checking valid"),o<40?e.assert(u.hasNext,"hasNext()"):e.assert(!u.hasNext,"eof hasNext()"),u.next();e.assert(!u.valid,"invalid eof iterator"),e.assert(!u.hasNext,"hasNext() at eof fail"),e.equals(u.index,41,"eof index"),e.end()}),tape("foreach",function(e){var r=iota(31).reduce(function(e,r,t){return e.insert(r,t)},makeTree()),t=[],a=[];r.forEach(function(e,r){t.push(e),a.push(r)}),e.same(t,r.keys),e.same(a,r.values),t=[],a=[],e.equals(r.forEach(function(e,r){if(5===e)return 1e3;t.push(e),a.push(r)}),1e3),e.same(t,r.keys.slice(0,5)),e.same(a,r.values.slice(0,5)),t=[],a=[],r.forEach(function(e,r){t.push(e),a.push(r)},3),e.same(t,r.keys.slice(3)),e.same(a,r.values.slice(3)),t=[],a=[],e.equals(r.forEach(function(e,r){if(12===e)return 1e3;t.push(e),a.push(r)},3),1e3),e.same(t,r.keys.slice(3,12)),e.same(a,r.values.slice(3,12)),t=[],a=[],r.forEach(function(e,r){t.push(e),a.push(r)},3,15),e.same(t,r.keys.slice(3,15)),e.same(a,r.values.slice(3,15)),t=[],a=[],e.equals(r.forEach(function(e,r){if(12===e)return 1e3;t.push(e),a.push(r)},3,15),1e3),e.same(t,r.keys.slice(3,12)),e.same(a,r.values.slice(3,12)),e.end()}),tape("iterators",function(e){var r=iota(20).reduce(function(e,r,t){return e.insert(r,t)},makeTree()),t=r.begin,a=t.clone();e.ok(t.hasNext,"must have next at beginneing"),e.ok(!t.hasPrev,"must not have predecessor");for(var s=0;s<20;++s){var n=r.at(s);compareIterators(t,n,e),e.equals(t.index,s),t.next()}e.ok(!t.valid,"must be eof iterator"),compareIterators(a,r.begin,e);var t=r.end;e.ok(!t.hasNext,"must not have next"),e.ok(t.hasPrev,"must have predecessor");for(var s=19;s>=0;--s){var n=r.at(s);compareIterators(t,n,e),e.equals(t.index,s),t.prev()}e.ok(!t.valid,"must be eof iterator"),e.end()}),tape("remove()",function(e){for(var r=[1,2,10,20,23,31,32,33],t=0;t<r.length;++t)for(var a=r[t],s=iota(a).reduce(function(e,r,t){return e.insert(r,t)},makeTree()),n=0;n<a;++n)checkTree(s.remove(n),e);e.end()}),tape("update()",function(e){for(var r=[0,1,2,3,4,5,6],t=r.reduce(function(e,r,t){return e.insert(r,t)},makeTree()),a=t.begin;a.hasNext;a.next()){var s=(a.value,a.update(1e3));e.equals(a.value,a.key,"ensure no mutation"),e.equals(s.find(a.key).value,1e3,"ensure update applied"),checkTree(s,e),checkTree(t,e)}e.end()}),tape("keys and values",function(e){for(var r=["potato","sock","foot","apple","newspaper","gameboy"],t=[42,10,!1,"!!!",{},null],a=makeTree(),s=0;s<r.length;++s)a=a.insert(r[s],t[s]);var n=iota(6).map(function(e){return[r[e],t[e]]});n.sort(function(e,r){return e[0]<r[0]?-1:e[0]>r[0]?1:0});var i=n.map(function(e){return e[0]}),l=n.map(function(e){return e[1]});e.same(a.keys,i),e.same(a.values,l),e.end()}),tape("searching",function(e){for(var r=[0,1,1,1,1,2,3,4,5,6,6],t=r.reduce(function(e,r,t){return e.insert(r,t)},makeTree()),a=0;a<r.length;++a)r[a]!==r[a-1]&&r[a]!==r[a+1]&&e.equals(t.get(r[a]),a,"get "+r[a]);e.equals(t.get(-1),void 0,"get missing"),e.equals(t.ge(3).index,6,"ge simple"),e.equals(t.ge(.9).index,1,"ge run start"),e.equals(t.ge(1).index,1,"ge run mid"),e.equals(t.ge(1.1).index,5,"ge run end"),e.equals(t.ge(0).index,0,"ge first"),e.equals(t.ge(6).index,9,"ge last"),e.equals(t.ge(100).valid,!1,"ge big"),e.equals(t.ge(-1).index,0,"ge small"),e.equals(t.gt(3).index,7,"gt simple"),e.equals(t.gt(.9).index,1,"gt run start"),e.equals(t.gt(1).index,5,"gt run mid"),e.equals(t.gt(1.1).index,5,"gt run end"),e.equals(t.gt(0).index,1,"gt first"),e.equals(t.gt(6).valid,!1,"gt last"),e.equals(t.gt(100).valid,!1,"gt big"),e.equals(t.gt(-1).index,0,"ge small"),e.equals(t.le(3).index,6,"le simple"),e.equals(t.le(.9).index,0,"le run start"),e.equals(t.le(1).index,4,"le run mid"),e.equals(t.le(1.1).index,4,"le run end"),e.equals(t.le(0).index,0,"le first"),e.equals(t.le(6).index,10,"le last"),e.equals(t.le(100).index,10,"le big"),e.equals(t.le(-1).valid,!1,"le small"),e.equals(t.lt(3).index,5,"lt simple"),e.equals(t.lt(.9).index,0,"lt run start"),e.equals(t.lt(1).index,0,"lt run mid"),e.equals(t.lt(1.1).index,4,"lt run end"),e.equals(t.lt(0).valid,!1,"lt first"),e.equals(t.lt(6).index,8,"lt last"),e.equals(t.lt(100).index,10,"lt big"),e.equals(t.lt(-1).valid,!1,"lt small"),e.equals(t.find(-1).valid,!1,"find missing small"),e.equals(t.find(1e4).valid,!1,"find missing big"),e.equals(t.find(3).index,6,"find simple"),e.ok(t.find(1).index>0,"find repeat"),e.ok(t.find(1).index<5,"find repeat");for(var a=0;a<r.length;++a)e.equals(t.find(r[a]).key,r[a],"find "+a);for(var a=0;a<r.length;++a)e.equals(t.at(a).key,r[a],"at "+a);e.equals(t.at(-1).valid,!1,"at missing small"),e.equals(t.at(1e3).valid,!1,"at missing big"),e.end()}),tape("slab-sequence",function(e){var r=makeTree();r=r.insert(0,0),checkTree(r,e),e.same(r.values,[0]),r=r.insert(1,1),checkTree(r,e),e.same(r.values,[0,1]),r=r.insert(.5,2),checkTree(r,e),e.same(r.values,[0,2,1]),r=r.insert(.25,3),checkTree(r,e),e.same(r.values,[0,3,2,1]),r=r.remove(0),checkTree(r,e),e.same(r.values,[3,2,1]),r=r.insert(.375,4),checkTree(r,e),e.same(r.values,[3,4,2,1]),r=r.remove(1),checkTree(r,e),e.same(r.values,[3,4,2]),r=r.remove(.5),checkTree(r,e),e.same(r.values,[3,4]),r=r.remove(.375),checkTree(r,e),e.same(r.values,[3]),r=r.remove(.25),checkTree(r,e),e.same(r.values,[]),e.end()}),tape("slab-sequence-2",function(e){var r=makeTree();r=r.insert(12,22),r=r.insert(11,3),r=r.insert(10,28),r=r.insert(13,16),r=r.insert(9,9),r=r.insert(14,10),r=r.insert(8,15),r=r.insert(15,29),r=r.insert(16,4),r=r.insert(7,21),r=r.insert(17,23),r=r.insert(6,2),r=r.insert(5,27),r=r.insert(18,17),r=r.insert(4,8),r=r.insert(31,11),r=r.insert(30,30),r=r.insert(29,5),r=r.insert(28,24),r=r.insert(27,18),r=r.insert(26,12),r=r.insert(25,31),r=r.insert(24,6),r=r.insert(23,25),r=r.insert(19,7),r=r.insert(20,13),r=r.insert(1,20),r=r.insert(0,14),r=r.insert(22,0),r=r.insert(2,1),r=r.insert(3,26),r=r.insert(21,19),r=r.remove(18,17),r=r.remove(17,23),r=r.remove(16,4),r=r.remove(15,29),r=r.remove(14,10),r=r.remove(13,16),r=r.remove(12,22),r=r.remove(6,2),r=r.remove(7,21),r=r.remove(8,15),r=r.remove(11,3),r=r.remove(4,8),r=r.remove(9,9),r=r.remove(10,28),r=r.remove(5,27),r=r.remove(31,11),r=r.remove(0,14),r=r.remove(30,30),r=r.remove(29,5),r=r.remove(1,20),r=r.remove(28,24),r=r.remove(2,1),r=r.remove(3,26),r=r.remove(27,18),r=r.remove(19,7),r=r.remove(26,12),r=r.remove(20,13),r=r.remove(25,31),r=r.remove(24,6),r=r.remove(21,19),r=r.remove(23,25),r=r.remove(22,0),e.end()});