/*!
 * Tmp
 *
 * Copyright (c) 2011-2017 KARASZI Istvan <github@spam.raszi.hu>
 *
 * MIT Licensed
 */

function _randomChars(e){var r=[],n=null;try{n=crypto.randomBytes(e)}catch(r){n=crypto.pseudoRandomBytes(e)}for(var t=0;t<e;t++)r.push(RANDOM_CHARS[n[t]%RANDOM_CHARS.length]);return r.join("")}function _isUndefined(e){return void 0===e}function _parseArguments(e,r){return"function"==typeof e?[r||{},e]:_isUndefined(e)?[{},r]:[e,r]}function _generateTmpName(e){if(e.name)return path.join(e.dir||tmpDir,e.name);if(e.template)return e.template.replace(TEMPLATE_PATTERN,_randomChars(6));const r=[e.prefix||"tmp-",process.pid,_randomChars(12),e.postfix||""].join("");return path.join(e.dir||tmpDir,r)}function tmpName(e,r){var n=_parseArguments(e,r),t=n[0],o=n[1],i=t.name?1:t.tries||DEFAULT_TRIES;return isNaN(i)||i<0?o(new Error("Invalid tries")):t.template&&!t.template.match(TEMPLATE_PATTERN)?o(new Error("Invalid template provided")):void function e(){const r=_generateTmpName(t);fs.stat(r,function(n){if(!n)return i-- >0?e():o(new Error("Could not get a unique tmp filename, max tries reached "+r));o(null,r)})}()}function tmpNameSync(e){var r=_parseArguments(e),n=r[0],t=n.name?1:n.tries||DEFAULT_TRIES;if(isNaN(t)||t<0)throw new Error("Invalid tries");if(n.template&&!n.template.match(TEMPLATE_PATTERN))throw new Error("Invalid template provided");do{const o=_generateTmpName(n);try{fs.statSync(o)}catch(e){return o}}while(t-- >0);throw new Error("Could not get a unique tmp filename, max tries reached")}function file(e,r){var n=_parseArguments(e,r),t=n[0],o=n[1];t.postfix=_isUndefined(t.postfix)?".tmp":t.postfix,tmpName(t,function(e,r){if(e)return o(e);fs.open(r,CREATE_FLAGS,t.mode||FILE_MODE,function(e,n){return e?o(e):t.discardDescriptor?fs.close(n,function(e){if(e){try{fs.unlinkSync(r)}catch(r){isENOENT(r)||(e=r)}return o(e)}o(null,r,void 0,_prepareTmpFileRemoveCallback(r,-1,t))}):t.detachDescriptor?o(null,r,n,_prepareTmpFileRemoveCallback(r,-1,t)):void o(null,r,n,_prepareTmpFileRemoveCallback(r,n,t))})})}function fileSync(e){var r=_parseArguments(e),n=r[0];n.postfix=n.postfix||".tmp";const t=n.discardDescriptor||n.detachDescriptor,o=tmpNameSync(n);var i=fs.openSync(o,CREATE_FLAGS,n.mode||FILE_MODE);return n.discardDescriptor&&(fs.closeSync(i),i=void 0),{name:o,fd:i,removeCallback:_prepareTmpFileRemoveCallback(o,t?-1:i,n)}}function _rmdirRecursiveSync(e){const r=[e];do{for(var n=r.pop(),t=!1,o=fs.readdirSync(n),i=0,c=o.length;i<c;i++){var a=path.join(n,o[i]);fs.lstatSync(a).isDirectory()?(t||(t=!0,r.push(n)),r.push(a)):fs.unlinkSync(a)}t||fs.rmdirSync(n)}while(0!==r.length)}function dir(e,r){var n=_parseArguments(e,r),t=n[0],o=n[1];tmpName(t,function(e,r){if(e)return o(e);fs.mkdir(r,t.mode||DIR_MODE,function(e){if(e)return o(e);o(null,r,_prepareTmpDirRemoveCallback(r,t))})})}function dirSync(e){var r=_parseArguments(e),n=r[0];const t=tmpNameSync(n);return fs.mkdirSync(t,n.mode||DIR_MODE),{name:t,removeCallback:_prepareTmpDirRemoveCallback(t,n)}}function _prepareTmpFileRemoveCallback(e,r,n){const t=_prepareRemoveCallback(function(e){try{0<=e[0]&&fs.closeSync(e[0])}catch(e){if(!isEBADF(e)&&!isENOENT(e))throw e}try{fs.unlinkSync(e[1])}catch(e){if(!isENOENT(e))throw e}},[r,e]);return n.keep||_removeObjects.unshift(t),t}function _prepareTmpDirRemoveCallback(e,r){const n=r.unsafeCleanup?_rmdirRecursiveSync:fs.rmdirSync.bind(fs),t=_prepareRemoveCallback(n,e);return r.keep||_removeObjects.unshift(t),t}function _prepareRemoveCallback(e,r){var n=!1;return function t(o){if(!n){const i=_removeObjects.indexOf(t);i>=0&&_removeObjects.splice(i,1),n=!0,e(r)}o&&o(null)}}function _garbageCollector(){if(!_uncaughtException||_gracefulCleanup)for(;_removeObjects.length;)try{_removeObjects[0].call(null)}catch(e){}}function isEBADF(e){return isExpectedError(e,-EBADF,"EBADF")}function isENOENT(e){return isExpectedError(e,-ENOENT,"ENOENT")}function isExpectedError(e,r,n){return e.code==r||e.code==n}function setGracefulCleanup(){_gracefulCleanup=!0}const fs=require("fs"),path=require("path"),crypto=require("crypto"),osTmpDir=require("os-tmpdir"),_c=process.binding("constants"),tmpDir=osTmpDir(),RANDOM_CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",TEMPLATE_PATTERN=/XXXXXX/,DEFAULT_TRIES=3,CREATE_FLAGS=(_c.O_CREAT||_c.fs.O_CREAT)|(_c.O_EXCL||_c.fs.O_EXCL)|(_c.O_RDWR||_c.fs.O_RDWR),EBADF=_c.EBADF||_c.os.errno.EBADF,ENOENT=_c.ENOENT||_c.os.errno.ENOENT,DIR_MODE=448,FILE_MODE=384,_removeObjects=[];var _gracefulCleanup=!1,_uncaughtException=!1;const version=process.versions.node.split(".").map(function(e){return parseInt(e,10)});0===version[0]&&(version[1]<9||9===version[1]&&version[2]<5)&&process.addListener("uncaughtException",function(e){throw _uncaughtException=!0,_garbageCollector(),e}),process.addListener("exit",function(e){e&&(_uncaughtException=!0),_garbageCollector()}),module.exports.tmpdir=tmpDir,module.exports.dir=dir,module.exports.dirSync=dirSync,module.exports.file=file,module.exports.fileSync=fileSync,module.exports.tmpName=tmpName,module.exports.tmpNameSync=tmpNameSync,module.exports.setGracefulCleanup=setGracefulCleanup;