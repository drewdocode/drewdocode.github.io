"use strict";function naiveLength(){return 1}function LRUCache(t){if(!(this instanceof LRUCache))return new LRUCache(t);"number"==typeof t&&(t={max:t}),t||(t={});var e=this[MAX]=t.max;(!e||"number"!=typeof e||e<=0)&&(this[MAX]=1/0);var n=t.length||naiveLength;"function"!=typeof n&&(n=naiveLength),this[LENGTH_CALCULATOR]=n,this[ALLOW_STALE]=t.stale||!1,this[MAX_AGE]=t.maxAge||0,this[DISPOSE]=t.dispose,this[NO_DISPOSE_ON_SET]=t.noDisposeOnSet||!1,this.reset()}function forEachStep(t,e,n,i){var r=n.value;isStale(t,r)&&(del(t,n),t[ALLOW_STALE]||(r=void 0)),r&&e.call(i,r.value,r.key,t)}function get(t,e,n){var i=t[CACHE].get(e);if(i){var r=i.value;isStale(t,r)?(del(t,i),t[ALLOW_STALE]||(r=void 0)):n&&t[LRU_LIST].unshiftNode(i),r&&(r=r.value)}return r}function isStale(t,e){if(!e||!e.maxAge&&!t[MAX_AGE])return!1;var n=Date.now()-e.now;return e.maxAge?n>e.maxAge:t[MAX_AGE]&&n>t[MAX_AGE]}function trim(t){if(t[LENGTH]>t[MAX])for(var e=t[LRU_LIST].tail;t[LENGTH]>t[MAX]&&null!==e;){var n=e.prev;del(t,e),e=n}}function del(t,e){if(e){var n=e.value;t[DISPOSE]&&t[DISPOSE](n.key,n.value),t[LENGTH]-=n.length,t[CACHE].delete(n.key),t[LRU_LIST].removeNode(e)}}function Entry(t,e,n,i,r){this.key=t,this.value=e,this.length=n,this.now=i,this.maxAge=r||0}module.exports=LRUCache;var Map=require("pseudomap"),util=require("util"),Yallist=require("yallist"),hasSymbol="function"==typeof Symbol,makeSymbol;makeSymbol=hasSymbol?function(t){return Symbol.for(t)}:function(t){return"_"+t};var MAX=makeSymbol("max"),LENGTH=makeSymbol("length"),LENGTH_CALCULATOR=makeSymbol("lengthCalculator"),ALLOW_STALE=makeSymbol("allowStale"),MAX_AGE=makeSymbol("maxAge"),DISPOSE=makeSymbol("dispose"),NO_DISPOSE_ON_SET=makeSymbol("noDisposeOnSet"),LRU_LIST=makeSymbol("lruList"),CACHE=makeSymbol("cache");Object.defineProperty(LRUCache.prototype,"max",{set:function(t){(!t||"number"!=typeof t||t<=0)&&(t=1/0),this[MAX]=t,trim(this)},get:function(){return this[MAX]},enumerable:!0}),Object.defineProperty(LRUCache.prototype,"allowStale",{set:function(t){this[ALLOW_STALE]=!!t},get:function(){return this[ALLOW_STALE]},enumerable:!0}),Object.defineProperty(LRUCache.prototype,"maxAge",{set:function(t){(!t||"number"!=typeof t||t<0)&&(t=0),this[MAX_AGE]=t,trim(this)},get:function(){return this[MAX_AGE]},enumerable:!0}),Object.defineProperty(LRUCache.prototype,"lengthCalculator",{set:function(t){"function"!=typeof t&&(t=naiveLength),t!==this[LENGTH_CALCULATOR]&&(this[LENGTH_CALCULATOR]=t,this[LENGTH]=0,this[LRU_LIST].forEach(function(t){t.length=this[LENGTH_CALCULATOR](t.value,t.key),this[LENGTH]+=t.length},this)),trim(this)},get:function(){return this[LENGTH_CALCULATOR]},enumerable:!0}),Object.defineProperty(LRUCache.prototype,"length",{get:function(){return this[LENGTH]},enumerable:!0}),Object.defineProperty(LRUCache.prototype,"itemCount",{get:function(){return this[LRU_LIST].length},enumerable:!0}),LRUCache.prototype.rforEach=function(t,e){e=e||this;for(var n=this[LRU_LIST].tail;null!==n;){var i=n.prev;forEachStep(this,t,n,e),n=i}},LRUCache.prototype.forEach=function(t,e){e=e||this;for(var n=this[LRU_LIST].head;null!==n;){var i=n.next;forEachStep(this,t,n,e),n=i}},LRUCache.prototype.keys=function(){return this[LRU_LIST].toArray().map(function(t){return t.key},this)},LRUCache.prototype.values=function(){return this[LRU_LIST].toArray().map(function(t){return t.value},this)},LRUCache.prototype.reset=function(){this[DISPOSE]&&this[LRU_LIST]&&this[LRU_LIST].length&&this[LRU_LIST].forEach(function(t){this[DISPOSE](t.key,t.value)},this),this[CACHE]=new Map,this[LRU_LIST]=new Yallist,this[LENGTH]=0},LRUCache.prototype.dump=function(){return this[LRU_LIST].map(function(t){if(!isStale(this,t))return{k:t.key,v:t.value,e:t.now+(t.maxAge||0)}},this).toArray().filter(function(t){return t})},LRUCache.prototype.dumpLru=function(){return this[LRU_LIST]},LRUCache.prototype.inspect=function(t,e){var n="LRUCache {",i=!1;this[ALLOW_STALE]&&(n+="\n  allowStale: true",i=!0);var r=this[MAX];r&&r!==1/0&&(i&&(n+=","),n+="\n  max: "+util.inspect(r,e),i=!0);var a=this[MAX_AGE];a&&(i&&(n+=","),n+="\n  maxAge: "+util.inspect(a,e),i=!0);var h=this[LENGTH_CALCULATOR];h&&h!==naiveLength&&(i&&(n+=","),n+="\n  length: "+util.inspect(this[LENGTH],e),i=!0);var o=!1;return this[LRU_LIST].forEach(function(t){o?n+=",\n  ":(i&&(n+=",\n"),o=!0,n+="\n  ");var r=util.inspect(t.key).split("\n").join("\n  "),s={value:t.value};t.maxAge!==a&&(s.maxAge=t.maxAge),h!==naiveLength&&(s.length=t.length),isStale(this,t)&&(s.stale=!0),s=util.inspect(s,e).split("\n").join("\n  "),n+=r+" => "+s}),(o||i)&&(n+="\n"),n+="}"},LRUCache.prototype.set=function(t,e,n){n=n||this[MAX_AGE];var i=n?Date.now():0,r=this[LENGTH_CALCULATOR](e,t);if(this[CACHE].has(t)){if(r>this[MAX])return del(this,this[CACHE].get(t)),!1;var a=this[CACHE].get(t),h=a.value;return this[DISPOSE]&&(this[NO_DISPOSE_ON_SET]||this[DISPOSE](t,h.value)),h.now=i,h.maxAge=n,h.value=e,this[LENGTH]+=r-h.length,h.length=r,this.get(t),trim(this),!0}var o=new Entry(t,e,r,i,n);return o.length>this[MAX]?(this[DISPOSE]&&this[DISPOSE](t,e),!1):(this[LENGTH]+=o.length,this[LRU_LIST].unshift(o),this[CACHE].set(t,this[LRU_LIST].head),trim(this),!0)},LRUCache.prototype.has=function(t){return!!this[CACHE].has(t)&&!isStale(this,this[CACHE].get(t).value)},LRUCache.prototype.get=function(t){return get(this,t,!0)},LRUCache.prototype.peek=function(t){return get(this,t,!1)},LRUCache.prototype.pop=function(){var t=this[LRU_LIST].tail;return t?(del(this,t),t.value):null},LRUCache.prototype.del=function(t){del(this,this[CACHE].get(t))},LRUCache.prototype.load=function(t){this.reset();for(var e=Date.now(),n=t.length-1;n>=0;n--){var i=t[n],r=i.e||0;if(0===r)this.set(i.k,i.v);else{var a=r-e;a>0&&this.set(i.k,i.v,a)}}},LRUCache.prototype.prune=function(){var t=this;this[CACHE].forEach(function(e,n){get(t,n,!1)})};