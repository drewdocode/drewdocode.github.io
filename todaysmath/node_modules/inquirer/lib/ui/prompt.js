var _=require("lodash"),rx=require("rx-lite-aggregates"),util=require("util"),runAsync=require("run-async"),utils=require("../utils/utils"),Base=require("./baseUI"),PromptUI=module.exports=function(e,t){Base.call(this,t),this.prompts=e};util.inherits(PromptUI,Base),PromptUI.prototype.run=function(e){this.answers={},_.isPlainObject(e)&&(e=[e]);var t=_.isArray(e)?rx.Observable.from(e):e;return this.process=t.concatMap(this.processQuestion.bind(this)).publish(),this.process.connect(),this.process.reduce(function(e,t){return _.set(this.answers,t.name,t.answer),this.answers}.bind(this),{}).toPromise(Promise).then(this.onCompletion.bind(this))},PromptUI.prototype.onCompletion=function(e){return this.close(),e},PromptUI.prototype.processQuestion=function(e){return e=_.clone(e),rx.Observable.defer(function(){return rx.Observable.of(e).concatMap(this.setDefaultType.bind(this)).concatMap(this.filterIfRunnable.bind(this)).concatMap(utils.fetchAsyncQuestionProperty.bind(null,e,"message",this.answers)).concatMap(utils.fetchAsyncQuestionProperty.bind(null,e,"default",this.answers)).concatMap(utils.fetchAsyncQuestionProperty.bind(null,e,"choices",this.answers)).concatMap(this.fetchAnswer.bind(this))}.bind(this))},PromptUI.prototype.fetchAnswer=function(e){var t=this.prompts[e.type];return this.activePrompt=new t(e,this.rl,this.answers),rx.Observable.defer(function(){return rx.Observable.fromPromise(this.activePrompt.run().then(function(t){return{name:e.name,answer:t}}))}.bind(this))},PromptUI.prototype.setDefaultType=function(e){return this.prompts[e.type]||(e.type="input"),rx.Observable.defer(function(){return rx.Observable.return(e)})},PromptUI.prototype.filterIfRunnable=function(e){if(!1===e.when)return rx.Observable.empty();if(!_.isFunction(e.when))return rx.Observable.return(e);var t=this.answers;return rx.Observable.defer(function(){return rx.Observable.fromPromise(runAsync(e.when)(t).then(function(t){if(t)return e})).filter(function(e){return null!=e})})};