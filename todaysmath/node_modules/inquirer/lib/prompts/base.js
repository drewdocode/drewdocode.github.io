var _=require("lodash"),chalk=require("chalk"),runAsync=require("run-async"),Choices=require("../objects/choices"),ScreenManager=require("../utils/screen-manager"),Prompt=module.exports=function(t,r,e){_.assign(this,{answers:e,status:"pending"}),this.opt=_.defaults(_.clone(t),{validate:function(){return!0},filter:function(t){return t},when:function(){return!0},suffix:"",prefix:chalk.green("?")}),this.opt.message||this.throwParamError("message"),this.opt.name||this.throwParamError("name"),Array.isArray(this.opt.choices)&&(this.opt.choices=new Choices(this.opt.choices,e)),this.rl=r,this.screen=new ScreenManager(this.rl)};Prompt.prototype.run=function(){return new Promise(function(t){this._run(function(r){t(r)})}.bind(this))},Prompt.prototype._run=function(t){t()},Prompt.prototype.throwParamError=function(t){throw new Error("You must provide a `"+t+"` parameter")},Prompt.prototype.close=function(){this.screen.releaseCursor()},Prompt.prototype.handleSubmitEvents=function(t){var r=this,e=runAsync(this.opt.validate),n=runAsync(this.opt.filter),i=t.flatMap(function(t){return n(t,r.answers).then(function(t){return e(t,r.answers).then(function(r){return{isValid:r,value:t}},function(t){return{isValid:t}})},function(t){return{isValid:t}})}).share(),s=i.filter(function(t){return!0===t.isValid}).take(1);return{success:s,error:i.filter(function(t){return!0!==t.isValid}).takeUntil(s)}},Prompt.prototype.getQuestion=function(){var t=this.opt.prefix+" "+chalk.bold(this.opt.message)+this.opt.suffix+chalk.reset(" ");return null!=this.opt.default&&"answered"!==this.status&&(t+=chalk.dim("("+this.opt.default+") ")),t};