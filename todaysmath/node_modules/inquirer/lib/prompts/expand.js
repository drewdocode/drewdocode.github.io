function Prompt(){Base.apply(this,arguments),this.opt.choices||this.throwParamError("choices"),this.validateChoices(this.opt.choices),this.opt.choices.push({key:"h",name:"Help, list all options",value:"help"}),this.opt.validate=function(e){return null==e?"Please enter a valid command":"help"!==e},this.opt.default=this.generateChoicesString(this.opt.choices,this.opt.default),this.paginator=new Paginator}function renderChoices(e,t){var r="";return e.forEach(function(e){if(r+="\n  ","separator"===e.type)return void(r+=" "+e);var i=e.key+") "+e.name;t===e.key&&(i=chalk.cyan(i)),r+=i}),r}var _=require("lodash"),util=require("util"),chalk=require("chalk"),Base=require("./base"),Separator=require("../objects/separator"),observe=require("../utils/events"),Paginator=require("../utils/paginator");module.exports=Prompt,util.inherits(Prompt,Base),Prompt.prototype._run=function(e){this.done=e;var t=observe(this.rl),r=this.handleSubmitEvents(t.line.map(this.getCurrentValue.bind(this)));return r.success.forEach(this.onSubmit.bind(this)),r.error.forEach(this.onError.bind(this)),this.keypressObs=t.keypress.takeUntil(r.success).forEach(this.onKeypress.bind(this)),this.render(),this},Prompt.prototype.render=function(e,t){var r=this.getQuestion(),i="";if("answered"===this.status)r+=chalk.cyan(this.answer);else if("expanded"===this.status){var s=renderChoices(this.opt.choices,this.selectedKey);r+=this.paginator.paginate(s,this.selectedKey,this.opt.pageSize),r+="\n  Answer: "}r+=this.rl.line,e&&(i=chalk.red(">> ")+e),t&&(i=chalk.cyan(">> ")+t),this.screen.render(r,i)},Prompt.prototype.getCurrentValue=function(e){e||(e=this.rawDefault);var t=this.opt.choices.where({key:e.toLowerCase().trim()})[0];return t?t.value:null},Prompt.prototype.getChoices=function(){var e="";return this.opt.choices.forEach(function(t){if(e+="\n  ","separator"===t.type)return void(e+=" "+t);var r=t.key+") "+t.name;this.selectedKey===t.key&&(r=chalk.cyan(r)),e+=r}.bind(this)),e},Prompt.prototype.onError=function(e){if("help"===e.value)return this.selectedKey="",this.status="expanded",void this.render();this.render(e.isValid)},Prompt.prototype.onSubmit=function(e){this.status="answered";var t=this.opt.choices.where({value:e.value})[0];this.answer=t.short||t.name,this.render(),this.screen.done(),this.done(e.value)},Prompt.prototype.onKeypress=function(){this.selectedKey=this.rl.line.toLowerCase();var e=this.opt.choices.where({key:this.selectedKey})[0];"expanded"===this.status?this.render():this.render(null,e?e.name:null)},Prompt.prototype.validateChoices=function(e){var t,r=[],i={};if(e.filter(Separator.exclude).forEach(function(e){e.key&&1===e.key.length||(t=!0),i[e.key]&&r.push(e.key),i[e.key]=!0,e.key=String(e.key).toLowerCase()}),t)throw new Error("Format error: `key` param must be a single letter and is required.");if(i.h)throw new Error("Reserved key error: `key` param cannot be `h` - this value is reserved.");if(r.length)throw new Error("Duplicate key error: `key` param must be unique. Duplicates: "+_.uniq(r).join(", "))},Prompt.prototype.generateChoicesString=function(e,t){var r=e.realLength-1;_.isNumber(t)&&this.opt.choices.getChoice(t)&&(r=t);var i=this.opt.choices.pluck("key");return this.rawDefault=i[r],i[r]=String(i[r]).toUpperCase(),i.join("")};