function height(t){return t.split("\n").length}function lastLine(t){return _.last(t.split("\n"))}function breakLines(t,r){var e=new RegExp("(?:(?:\\033[[0-9;]*m)*.?){1,"+r+"}","g");return t.map(function(t){var r=t.match(e);return r.pop(),r||""})}function forceLineReturn(t,r){return _.flatten(breakLines(t.split("\n"),r)).join("\n")}var _=require("lodash"),util=require("./readline"),cliWidth=require("cli-width"),stripAnsi=require("strip-ansi"),stringWidth=require("string-width"),ScreenManager=module.exports=function(t){this.height=0,this.extraLinesUnderPrompt=0,this.rl=t};ScreenManager.prototype.render=function(t,r){this.rl.output.unmute(),this.clean(this.extraLinesUnderPrompt);var e=lastLine(t),i=stripAnsi(e),n=i;this.rl.line.length&&(n=n.slice(0,-this.rl.line.length)),this.rl.setPrompt(n);var s=this.rl._getCursorPos(),l=this.normalizedCliWidth();t=forceLineReturn(t,l),r&&(r=forceLineReturn(r,l)),i.length%l==0&&(t+="\n");var h=t+(r?"\n"+r:"");this.rl.output.write(h);var o=Math.floor(i.length/l)-s.rows,u=o+(r?height(r):0);u>0&&util.up(this.rl,u),util.left(this.rl,stringWidth(lastLine(h))),util.right(this.rl,s.cols),this.extraLinesUnderPrompt=u,this.height=height(h),this.rl.output.mute()},ScreenManager.prototype.clean=function(t){t>0&&util.down(this.rl,t),util.clearLine(this.rl,this.height)},ScreenManager.prototype.done=function(){this.rl.setPrompt(""),this.rl.output.unmute(),this.rl.output.write("\n")},ScreenManager.prototype.releaseCursor=function(){this.extraLinesUnderPrompt>0&&util.down(this.rl,this.extraLinesUnderPrompt)},ScreenManager.prototype.normalizedCliWidth=function(){var t=cliWidth({defaultWidth:80,output:this.rl.output});return"win32"===process.platform?t-1:t};