!function(){"use strict";function e(e){return-1==="><(){}[],:*|?!=".indexOf(String.fromCharCode(e))&&!F.code.isWhiteSpace(e)&&!F.code.isLineTerminator(e)}function r(e,r,t,n){this._previous=e,this._index=r,this._token=t,this._value=n}function t(e,r){return Q&&(e.range=[r[0]+K,r[1]+K]),e}function n(){var e=B.charAt(w);return w+=1,e}function i(e){var r,t,i,a=0;for(t="u"===e?4:2,r=0;r<t;++r){if(!(w<P&&F.code.isHexDigit(B.charCodeAt(w))))return"";i=n(),a=16*a+"0123456789abcdef".indexOf(i.toLowerCase())}return String.fromCharCode(a)}function a(){var e,r,t,a,o,s="";for(e=B.charAt(w),++w;w<P;){if((r=n())===e){e="";break}if("\\"===r)if(r=n(),F.code.isLineTerminator(r.charCodeAt(0)))"\r"===r&&10===B.charCodeAt(w)&&++w;else switch(r){case"n":s+="\n";break;case"r":s+="\r";break;case"t":s+="\t";break;case"u":case"x":o=w,a=i(r),a?s+=a:(w=o,s+=r);break;case"b":s+="\b";break;case"f":s+="\f";break;case"v":s+="\v";break;default:F.code.isOctalDigit(r.charCodeAt(0))?(t="01234567".indexOf(r),w<P&&F.code.isOctalDigit(B.charCodeAt(w))&&(t=8*t+"01234567".indexOf(n()),"0123".indexOf(r)>=0&&w<P&&F.code.isOctalDigit(B.charCodeAt(w))&&(t=8*t+"01234567".indexOf(n()))),s+=String.fromCharCode(t)):s+=r}else{if(F.code.isLineTerminator(r.charCodeAt(0)))break;s+=r}}return""!==e&&G.throwError("unexpected quote"),D=s,S.STRING}function o(){var e,r;if(e="",46!==(r=B.charCodeAt(w))){if(e=n(),r=B.charCodeAt(w),"0"===e){if(120===r||88===r){for(e+=n();w<P&&(r=B.charCodeAt(w),F.code.isHexDigit(r));)e+=n();return e.length<=2&&G.throwError("unexpected token"),w<P&&(r=B.charCodeAt(w),F.code.isIdentifierStartES5(r)&&G.throwError("unexpected token")),D=parseInt(e,16),S.NUMBER}if(F.code.isOctalDigit(r)){for(e+=n();w<P&&(r=B.charCodeAt(w),F.code.isOctalDigit(r));)e+=n();return w<P&&(r=B.charCodeAt(w),(F.code.isIdentifierStartES5(r)||F.code.isDecimalDigit(r))&&G.throwError("unexpected token")),D=parseInt(e,8),S.NUMBER}F.code.isDecimalDigit(r)&&G.throwError("unexpected token")}for(;w<P&&(r=B.charCodeAt(w),F.code.isDecimalDigit(r));)e+=n()}if(46===r)for(e+=n();w<P&&(r=B.charCodeAt(w),F.code.isDecimalDigit(r));)e+=n();if(101===r||69===r)if(e+=n(),r=B.charCodeAt(w),43!==r&&45!==r||(e+=n()),r=B.charCodeAt(w),F.code.isDecimalDigit(r))for(e+=n();w<P&&(r=B.charCodeAt(w),F.code.isDecimalDigit(r));)e+=n();else G.throwError("unexpected token");return w<P&&(r=B.charCodeAt(w),F.code.isIdentifierStartES5(r)&&G.throwError("unexpected token")),D=parseFloat(e),S.NUMBER}function s(){for(D=n();w<P&&e(B.charCodeAt(w));){if(46===B.charCodeAt(w)){if(w+1>=P)return S.ILLEGAL;if(60===B.charCodeAt(w+1))break}D+=n()}return S.NAME}function c(){var r;for(U=w;w<P&&F.code.isWhiteSpace(B.charCodeAt(w));)n();if(w>=P)return I=S.EOF;switch(r=B.charCodeAt(w)){case 39:case 34:return I=a();case 58:return n(),I=S.COLON;case 44:return n(),I=S.COMMA;case 40:return n(),I=S.LPAREN;case 41:return n(),I=S.RPAREN;case 91:return n(),I=S.LBRACK;case 93:return n(),I=S.RBRACK;case 123:return n(),I=S.LBRACE;case 125:return n(),I=S.RBRACE;case 46:if(w+1<P){if(60===(r=B.charCodeAt(w+1)))return n(),n(),I=S.DOT_LT;if(46===r&&w+2<P&&46===B.charCodeAt(w+2))return n(),n(),n(),I=S.REST;if(F.code.isDecimalDigit(r))return I=o()}return I=S.ILLEGAL;case 60:return n(),I=S.LT;case 62:return n(),I=S.GT;case 42:return n(),I=S.STAR;case 124:return n(),I=S.PIPE;case 63:return n(),I=S.QUESTION;case 33:return n(),I=S.BANG;case 61:return n(),I=S.EQUAL;case 45:return I=o();default:return F.code.isDecimalDigit(r)?I=o():(G.assert(e(r)),I=s())}}function p(e,r){G.assert(I===e,r||"consumed token not matched"),c()}function l(e,r){I!==e&&G.throwError(r||"unexpected token"),c()}function u(){var e,r=w-1;if(p(S.LPAREN,"UnionType should start with ("),e=[],I!==S.RPAREN)for(;;){if(e.push(x()),I===S.RPAREN)break;l(S.PIPE)}return p(S.RPAREN,"UnionType should end with )"),t({type:v.UnionType,elements:e},[r,U])}function d(){var e,r,n=w-1;for(p(S.LBRACK,"ArrayType should start with ["),e=[];I!==S.RBRACK;){if(I===S.REST){r=w-3,p(S.REST),e.push(t({type:v.RestType,expression:x()},[r,U]));break}e.push(x()),I!==S.RBRACK&&l(S.COMMA)}return l(S.RBRACK),t({type:v.ArrayType,elements:e},[n,U])}function A(){var e=D;return I===S.NAME||I===S.STRING?(c(),e):I===S.NUMBER?(p(S.NUMBER),String(e)):void G.throwError("unexpected token")}function f(){var e,r=U;return e=A(),I===S.COLON?(p(S.COLON),t({type:v.FieldType,key:e,value:x()},[r,U])):t({type:v.FieldType,key:e,value:null},[r,U])}function y(){var e,r,n=w-1;if(p(S.LBRACE,"RecordType should start with {"),e=[],I===S.COMMA)p(S.COMMA);else for(;I!==S.RBRACE;)e.push(f()),I!==S.RBRACE&&l(S.COMMA);return r=w,l(S.RBRACE),t({type:v.RecordType,fields:e},[n,r])}function T(){var e=D,r=w-e.length;return l(S.NAME),I!==S.COLON||"module"!==e&&"external"!==e&&"event"!==e||(p(S.COLON),e+=":"+D,l(S.NAME)),t({type:v.NameExpression,name:e},[r,U])}function E(){var e=[];for(e.push(O());I===S.COMMA;)p(S.COMMA),e.push(O());return e}function h(){var e,r,n=w-D.length;return e=T(),I===S.DOT_LT||I===S.LT?(c(),r=E(),l(S.GT),t({type:v.TypeApplication,expression:e,applications:r},[n,U])):e}function N(){return p(S.COLON,"ResultType should start with :"),I===S.NAME&&"void"===D?(p(S.NAME),{type:v.VoidLiteral}):x()}function R(){for(var e,r,n,i=[],a=!1,o=!1,s=w-3;I!==S.RPAREN;)I===S.REST&&(p(S.REST),o=!0),r=U,e=x(),e.type===v.NameExpression&&I===S.COLON&&(n=U-e.name.length,p(S.COLON),e=t({type:v.ParameterType,name:e.name,expression:x()},[n,U])),I===S.EQUAL?(p(S.EQUAL),e=t({type:v.OptionalType,expression:e},[r,U]),a=!0):a&&G.throwError("unexpected token"),o&&(e=t({type:v.RestType,expression:e},[s,U])),i.push(e),I!==S.RPAREN&&l(S.COMMA);return i}function L(){var e,r,n,i,a,o=w-D.length;return G.assert(I===S.NAME&&"function"===D,"FunctionType should start with 'function'"),p(S.NAME),l(S.LPAREN),e=!1,n=[],r=null,I!==S.RPAREN&&(I!==S.NAME||"this"!==D&&"new"!==D?n=R():(e="new"===D,p(S.NAME),l(S.COLON),r=h(),I===S.COMMA&&(p(S.COMMA),n=R()))),l(S.RPAREN),i=null,I===S.COLON&&(i=N()),a=t({type:v.FunctionType,params:n,result:i},[o,U]),r&&(a.this=r,e&&(a.new=!0)),a}function C(){var e,n;switch(I){case S.STAR:return p(S.STAR),t({type:v.AllLiteral},[U-1,U]);case S.LPAREN:return u();case S.LBRACK:return d();case S.LBRACE:return y();case S.NAME:if(n=w-D.length,"null"===D)return p(S.NAME),t({type:v.NullLiteral},[n,U]);if("undefined"===D)return p(S.NAME),t({type:v.UndefinedLiteral},[n,U]);if("true"===D||"false"===D)return p(S.NAME),t({type:v.BooleanLiteralType,value:"true"===D},[n,U]);if(e=r.save(),"function"===D)try{return L()}catch(r){e.restore()}return h();case S.STRING:return c(),t({type:v.StringLiteralType,value:D},[U-D.length-2,U]);case S.NUMBER:return c(),t({type:v.NumericLiteralType,value:D},[U-String(D).length,U]);default:G.throwError("unexpected token")}}function x(){var e,r;return I===S.QUESTION?(r=w-1,p(S.QUESTION),I===S.COMMA||I===S.EQUAL||I===S.RBRACE||I===S.RPAREN||I===S.PIPE||I===S.EOF||I===S.RBRACK||I===S.GT?t({type:v.NullableLiteral},[r,U]):t({type:v.NullableType,expression:C(),prefix:!0},[r,U])):I===S.BANG?(r=w-1,p(S.BANG),t({type:v.NonNullableType,expression:C(),prefix:!0},[r,U])):(r=U,e=C(),I===S.BANG?(p(S.BANG),t({type:v.NonNullableType,expression:e,prefix:!1},[r,U])):I===S.QUESTION?(p(S.QUESTION),t({type:v.NullableType,expression:e,prefix:!1},[r,U])):I===S.LBRACK?(p(S.LBRACK),l(S.RBRACK,"expected an array-style type declaration ("+D+"[])"),t({type:v.TypeApplication,expression:t({type:v.NameExpression,name:"Array"},[r,U]),applications:[e]},[r,U])):e)}function O(){var e,r;if(e=x(),I!==S.PIPE)return e;for(r=[e],p(S.PIPE);;){if(r.push(x()),I!==S.PIPE)break;p(S.PIPE)}return t({type:v.UnionType,elements:r},[0,w])}function m(){var e;return I===S.REST?(p(S.REST),t({type:v.RestType,expression:O()},[0,w])):(e=O(),I===S.EQUAL?(p(S.EQUAL),t({type:v.OptionalType,expression:e},[0,w])):e)}function k(e,r){var t;return B=e,P=B.length,w=0,U=0,Q=r&&r.range,K=r&&r.startIndex||0,c(),t=O(),r&&r.midstream?{expression:t,index:U}:(I!==S.EOF&&G.throwError("not reach to EOF"),t)}function b(e,r){var t;return B=e,P=B.length,w=0,U=0,Q=r&&r.range,K=r&&r.startIndex||0,c(),t=m(),r&&r.midstream?{expression:t,index:U}:(I!==S.EOF&&G.throwError("not reach to EOF"),t)}function M(e,r,t){var n,i,a;switch(e.type){case v.NullableLiteral:n="?";break;case v.AllLiteral:n="*";break;case v.NullLiteral:n="null";break;case v.UndefinedLiteral:n="undefined";break;case v.VoidLiteral:n="void";break;case v.UnionType:for(n=t?"":"(",i=0,a=e.elements.length;i<a;++i)n+=M(e.elements[i],r),i+1!==a&&(n+=r?"|":" | ");t||(n+=")");break;case v.ArrayType:for(n="[",i=0,a=e.elements.length;i<a;++i)n+=M(e.elements[i],r),i+1!==a&&(n+=r?",":", ");n+="]";break;case v.RecordType:for(n="{",i=0,a=e.fields.length;i<a;++i)n+=M(e.fields[i],r),i+1!==a&&(n+=r?",":", ");n+="}";break;case v.FieldType:n=e.value?e.key+(r?":":": ")+M(e.value,r):e.key;break;case v.FunctionType:for(n=r?"function(":"function (",e.this&&(e.new?n+=r?"new:":"new: ":n+=r?"this:":"this: ",n+=M(e.this,r),0!==e.params.length&&(n+=r?",":", ")),i=0,a=e.params.length;i<a;++i)n+=M(e.params[i],r),i+1!==a&&(n+=r?",":", ");n+=")",e.result&&(n+=(r?":":": ")+M(e.result,r));break;case v.ParameterType:n=e.name+(r?":":": ")+M(e.expression,r);break;case v.RestType:n="...",e.expression&&(n+=M(e.expression,r));break;case v.NonNullableType:n=e.prefix?"!"+M(e.expression,r):M(e.expression,r)+"!";break;case v.OptionalType:n=M(e.expression,r)+"=";break;case v.NullableType:n=e.prefix?"?"+M(e.expression,r):M(e.expression,r)+"?";break;case v.NameExpression:n=e.name;break;case v.TypeApplication:for(n=M(e.expression,r)+".<",i=0,a=e.applications.length;i<a;++i)n+=M(e.applications[i],r),i+1!==a&&(n+=r?",":", ");n+=">";break;case v.StringLiteralType:n='"'+e.value+'"';break;case v.NumericLiteralType:case v.BooleanLiteralType:n=String(e.value);break;default:G.throwError("Unknown type "+e.type)}return n}function g(e,r){return null==r&&(r={}),M(e,r.compact,r.topLevel)}var v,S,B,P,w,U,I,D,F,G,K,Q;F=require("esutils"),G=require("./utility"),v={NullableLiteral:"NullableLiteral",AllLiteral:"AllLiteral",NullLiteral:"NullLiteral",UndefinedLiteral:"UndefinedLiteral",VoidLiteral:"VoidLiteral",UnionType:"UnionType",ArrayType:"ArrayType",RecordType:"RecordType",FieldType:"FieldType",FunctionType:"FunctionType",ParameterType:"ParameterType",RestType:"RestType",NonNullableType:"NonNullableType",OptionalType:"OptionalType",NullableType:"NullableType",NameExpression:"NameExpression",TypeApplication:"TypeApplication",StringLiteralType:"StringLiteralType",NumericLiteralType:"NumericLiteralType",BooleanLiteralType:"BooleanLiteralType"},S={ILLEGAL:0,DOT_LT:1,REST:2,LT:3,GT:4,LPAREN:5,RPAREN:6,LBRACE:7,RBRACE:8,LBRACK:9,RBRACK:10,COMMA:11,COLON:12,STAR:13,PIPE:14,QUESTION:15,BANG:16,EQUAL:17,NAME:18,STRING:19,NUMBER:20,EOF:21},r.prototype.restore=function(){U=this._previous,w=this._index,I=this._token,D=this._value},r.save=function(){return new r(U,w,I,D)},exports.parseType=k,exports.parseParamType=b,exports.stringify=g,exports.Syntax=v}();