var XHTMLEntities=require("./xhtml"),hexNumber=/^[\da-fA-F]+$/,decimalNumber=/^\d+$/;module.exports=function(t){function s(t){return"JSXIdentifier"===t.type?t.name:"JSXNamespacedName"===t.type?t.namespace.name+":"+t.name.name:"JSXMemberExpression"===t.type?s(t.object)+"."+s(t.property):void 0}var e=t.tokTypes,i=t.tokContexts;i.j_oTag=new t.TokContext("<tag",!1),i.j_cTag=new t.TokContext("</tag",!1),i.j_expr=new t.TokContext("<tag>...</tag>",!0,!0),e.jsxName=new t.TokenType("jsxName"),e.jsxText=new t.TokenType("jsxText",{beforeExpr:!0}),e.jsxTagStart=new t.TokenType("jsxTagStart"),e.jsxTagEnd=new t.TokenType("jsxTagEnd"),e.jsxTagStart.updateContext=function(){this.context.push(i.j_expr),this.context.push(i.j_oTag),this.exprAllowed=!1},e.jsxTagEnd.updateContext=function(t){var s=this.context.pop();s===i.j_oTag&&t===e.slash||s===i.j_cTag?(this.context.pop(),this.exprAllowed=this.curContext()===i.j_expr):this.exprAllowed=!0};var n=t.Parser.prototype;return n.jsx_readToken=function(){for(var s="",i=this.pos;;){this.pos>=this.input.length&&this.raise(this.start,"Unterminated JSX contents");var n=this.input.charCodeAt(this.pos);switch(n){case 60:case 123:return this.pos===this.start?60===n&&this.exprAllowed?(++this.pos,this.finishToken(e.jsxTagStart)):this.getTokenFromCode(n):(s+=this.input.slice(i,this.pos),this.finishToken(e.jsxText,s));case 38:s+=this.input.slice(i,this.pos),s+=this.jsx_readEntity(),i=this.pos;break;default:t.isNewLine(n)?(s+=this.input.slice(i,this.pos),s+=this.jsx_readNewLine(!0),i=this.pos):++this.pos}}},n.jsx_readNewLine=function(t){var s,e=this.input.charCodeAt(this.pos);return++this.pos,13===e&&10===this.input.charCodeAt(this.pos)?(++this.pos,s=t?"\n":"\r\n"):s=String.fromCharCode(e),this.options.locations&&(++this.curLine,this.lineStart=this.pos),s},n.jsx_readString=function(s){for(var i="",n=++this.pos;;){this.pos>=this.input.length&&this.raise(this.start,"Unterminated string constant");var r=this.input.charCodeAt(this.pos);if(r===s)break;38===r?(i+=this.input.slice(n,this.pos),i+=this.jsx_readEntity(),n=this.pos):t.isNewLine(r)?(i+=this.input.slice(n,this.pos),i+=this.jsx_readNewLine(!1),n=this.pos):++this.pos}return i+=this.input.slice(n,this.pos++),this.finishToken(e.string,i)},n.jsx_readEntity=function(){var t,s="",e=0,i=this.input[this.pos];"&"!==i&&this.raise(this.pos,"Entity must start with an ampersand");for(var n=++this.pos;this.pos<this.input.length&&e++<10;){if(";"===(i=this.input[this.pos++])){"#"===s[0]?"x"===s[1]?(s=s.substr(2),hexNumber.test(s)&&(t=String.fromCharCode(parseInt(s,16)))):(s=s.substr(1),decimalNumber.test(s)&&(t=String.fromCharCode(parseInt(s,10)))):t=XHTMLEntities[s];break}s+=i}return t||(this.pos=n,"&")},n.jsx_readWord=function(){var s,i=this.pos;do{s=this.input.charCodeAt(++this.pos)}while(t.isIdentifierChar(s)||45===s);return this.finishToken(e.jsxName,this.input.slice(i,this.pos))},n.jsx_parseIdentifier=function(){var t=this.startNode();return this.type===e.jsxName?t.name=this.value:this.type.keyword?t.name=this.type.keyword:this.unexpected(),this.next(),this.finishNode(t,"JSXIdentifier")},n.jsx_parseNamespacedName=function(){var t=this.start,s=this.startLoc,i=this.jsx_parseIdentifier();if(!this.options.plugins.jsx.allowNamespaces||!this.eat(e.colon))return i;var n=this.startNodeAt(t,s);return n.namespace=i,n.name=this.jsx_parseIdentifier(),this.finishNode(n,"JSXNamespacedName")},n.jsx_parseElementName=function(){var t=this.start,s=this.startLoc,i=this.jsx_parseNamespacedName();for(this.type!==e.dot||"JSXNamespacedName"!==i.type||this.options.plugins.jsx.allowNamespacedObjects||this.unexpected();this.eat(e.dot);){var n=this.startNodeAt(t,s);n.object=i,n.property=this.jsx_parseIdentifier(),i=this.finishNode(n,"JSXMemberExpression")}return i},n.jsx_parseAttributeValue=function(){switch(this.type){case e.braceL:var t=this.jsx_parseExpressionContainer();return"JSXEmptyExpression"===t.expression.type&&this.raise(t.start,"JSX attributes must only be assigned a non-empty expression"),t;case e.jsxTagStart:case e.string:return this.parseExprAtom();default:this.raise(this.start,"JSX value should be either an expression or a quoted JSX text")}},n.jsx_parseEmptyExpression=function(){var t=this.startNodeAt(this.lastTokEnd,this.lastTokEndLoc);return this.finishNodeAt(t,"JSXEmptyExpression",this.start,this.startLoc)},n.jsx_parseExpressionContainer=function(){var t=this.startNode();return this.next(),t.expression=this.type===e.braceR?this.jsx_parseEmptyExpression():this.parseExpression(),this.expect(e.braceR),this.finishNode(t,"JSXExpressionContainer")},n.jsx_parseAttribute=function(){var t=this.startNode();return this.eat(e.braceL)?(this.expect(e.ellipsis),t.argument=this.parseMaybeAssign(),this.expect(e.braceR),this.finishNode(t,"JSXSpreadAttribute")):(t.name=this.jsx_parseNamespacedName(),t.value=this.eat(e.eq)?this.jsx_parseAttributeValue():null,this.finishNode(t,"JSXAttribute"))},n.jsx_parseOpeningElementAt=function(t,s){var i=this.startNodeAt(t,s);for(i.attributes=[],i.name=this.jsx_parseElementName();this.type!==e.slash&&this.type!==e.jsxTagEnd;)i.attributes.push(this.jsx_parseAttribute());return i.selfClosing=this.eat(e.slash),this.expect(e.jsxTagEnd),this.finishNode(i,"JSXOpeningElement")},n.jsx_parseClosingElementAt=function(t,s){var i=this.startNodeAt(t,s);return i.name=this.jsx_parseElementName(),this.expect(e.jsxTagEnd),this.finishNode(i,"JSXClosingElement")},n.jsx_parseElementAt=function(t,i){var n=this.startNodeAt(t,i),r=[],a=this.jsx_parseOpeningElementAt(t,i),h=null;if(!a.selfClosing){t:for(;;)switch(this.type){case e.jsxTagStart:if(t=this.start,i=this.startLoc,this.next(),this.eat(e.slash)){h=this.jsx_parseClosingElementAt(t,i);break t}r.push(this.jsx_parseElementAt(t,i));break;case e.jsxText:r.push(this.parseExprAtom());break;case e.braceL:r.push(this.jsx_parseExpressionContainer());break;default:this.unexpected()}s(h.name)!==s(a.name)&&this.raise(h.start,"Expected corresponding JSX closing tag for <"+s(a.name)+">")}return n.openingElement=a,n.closingElement=h,n.children=r,this.type===e.relational&&"<"===this.value&&this.raise(this.start,"Adjacent JSX elements must be wrapped in an enclosing tag"),this.finishNode(n,"JSXElement")},n.jsx_parseElement=function(){var t=this.start,s=this.startLoc;return this.next(),this.jsx_parseElementAt(t,s)},t.plugins.jsx=function(s,n){n&&("object"!=typeof n&&(n={}),s.options.plugins.jsx={allowNamespaces:!1!==n.allowNamespaces,allowNamespacedObjects:!!n.allowNamespacedObjects},s.extend("parseExprAtom",function(t){return function(s){return this.type===e.jsxText?this.parseLiteral(this.value):this.type===e.jsxTagStart?this.jsx_parseElement():t.call(this,s)}}),s.extend("readToken",function(s){return function(n){var r=this.curContext();if(r===i.j_expr)return this.jsx_readToken();if(r===i.j_oTag||r===i.j_cTag){if(t.isIdentifierStart(n))return this.jsx_readWord();if(62==n)return++this.pos,this.finishToken(e.jsxTagEnd);if((34===n||39===n)&&r==i.j_oTag)return this.jsx_readString(n)}return 60===n&&this.exprAllowed?(++this.pos,this.finishToken(e.jsxTagStart)):s.call(this,n)}}),s.extend("updateContext",function(t){return function(s){if(this.type==e.braceL){var n=this.curContext();n==i.j_oTag?this.context.push(i.b_expr):n==i.j_expr?this.context.push(i.b_tmpl):t.call(this,s),this.exprAllowed=!0}else{if(this.type!==e.slash||s!==e.jsxTagStart)return t.call(this,s);this.context.length-=2,this.context.push(i.j_cTag),this.exprAllowed=!1}}}))},t};