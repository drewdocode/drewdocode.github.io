function patch(n){constants.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)&&patchLchmod(n),n.lutimes||patchLutimes(n),n.chown=chownFix(n.chown),n.fchown=chownFix(n.fchown),n.lchown=chownFix(n.lchown),n.chmod=chmodFix(n.chmod),n.fchmod=chmodFix(n.fchmod),n.lchmod=chmodFix(n.lchmod),n.chownSync=chownFixSync(n.chownSync),n.fchownSync=chownFixSync(n.fchownSync),n.lchownSync=chownFixSync(n.lchownSync),n.chmodSync=chmodFixSync(n.chmodSync),n.fchmodSync=chmodFixSync(n.fchmodSync),n.lchmodSync=chmodFixSync(n.lchmodSync),n.stat=statFix(n.stat),n.fstat=statFix(n.fstat),n.lstat=statFix(n.lstat),n.statSync=statFixSync(n.statSync),n.fstatSync=statFixSync(n.fstatSync),n.lstatSync=statFixSync(n.lstatSync),n.lchmod||(n.lchmod=function(n,c,t){t&&process.nextTick(t)},n.lchmodSync=function(){}),n.lchown||(n.lchown=function(n,c,t,o){o&&process.nextTick(o)},n.lchownSync=function(){}),"win32"===platform&&(n.rename=function(c){return function(t,o,i){var r=Date.now(),s=0;c(t,o,function e(u){if(u&&("EACCES"===u.code||"EPERM"===u.code)&&Date.now()-r<6e4)return setTimeout(function(){n.stat(o,function(n,r){n&&"ENOENT"===n.code?c(t,o,e):i(u)})},s),void(s<100&&(s+=10));i&&i(u)})}}(n.rename)),n.read=function(c){return function(t,o,i,r,s,e){var u;if(e&&"function"==typeof e){var f=0;u=function(a,h,l){if(a&&"EAGAIN"===a.code&&f<10)return f++,c.call(n,t,o,i,r,s,u);e.apply(this,arguments)}}return c.call(n,t,o,i,r,s,u)}}(n.read),n.readSync=function(c){return function(t,o,i,r,s){for(var e=0;;)try{return c.call(n,t,o,i,r,s)}catch(n){if("EAGAIN"===n.code&&e<10){e++;continue}throw n}}}(n.readSync)}function patchLchmod(n){n.lchmod=function(c,t,o){n.open(c,constants.O_WRONLY|constants.O_SYMLINK,t,function(c,i){if(c)return void(o&&o(c));n.fchmod(i,t,function(c){n.close(i,function(n){o&&o(c||n)})})})},n.lchmodSync=function(c,t){var o,i=n.openSync(c,constants.O_WRONLY|constants.O_SYMLINK,t),r=!0;try{o=n.fchmodSync(i,t),r=!1}finally{if(r)try{n.closeSync(i)}catch(n){}else n.closeSync(i)}return o}}function patchLutimes(n){constants.hasOwnProperty("O_SYMLINK")?(n.lutimes=function(c,t,o,i){n.open(c,constants.O_SYMLINK,function(c,r){if(c)return void(i&&i(c));n.futimes(r,t,o,function(c){n.close(r,function(n){i&&i(c||n)})})})},n.lutimesSync=function(c,t,o){var i,r=n.openSync(c,constants.O_SYMLINK),s=!0;try{i=n.futimesSync(r,t,o),s=!1}finally{if(s)try{n.closeSync(r)}catch(n){}else n.closeSync(r)}return i}):(n.lutimes=function(n,c,t,o){o&&process.nextTick(o)},n.lutimesSync=function(){})}function chmodFix(n){return n?function(c,t,o){return n.call(fs,c,t,function(n){chownErOk(n)&&(n=null),o&&o.apply(this,arguments)})}:n}function chmodFixSync(n){return n?function(c,t){try{return n.call(fs,c,t)}catch(n){if(!chownErOk(n))throw n}}:n}function chownFix(n){return n?function(c,t,o,i){return n.call(fs,c,t,o,function(n){chownErOk(n)&&(n=null),i&&i.apply(this,arguments)})}:n}function chownFixSync(n){return n?function(c,t,o){try{return n.call(fs,c,t,o)}catch(n){if(!chownErOk(n))throw n}}:n}function statFix(n){return n?function(c,t){return n.call(fs,c,function(n,c){if(!c)return t.apply(this,arguments);c.uid<0&&(c.uid+=4294967296),c.gid<0&&(c.gid+=4294967296),t&&t.apply(this,arguments)})}:n}function statFixSync(n){return n?function(c){var t=n.call(fs,c);return t.uid<0&&(t.uid+=4294967296),t.gid<0&&(t.gid+=4294967296),t}:n}function chownErOk(n){return!n||("ENOSYS"===n.code||!(process.getuid&&0===process.getuid()||"EINVAL"!==n.code&&"EPERM"!==n.code))}var fs=require("./fs.js"),constants=require("constants"),origCwd=process.cwd,cwd=null,platform=process.env.GRACEFUL_FS_PLATFORM||process.platform;process.cwd=function(){return cwd||(cwd=origCwd.call(process)),cwd};try{process.cwd()}catch(n){}var chdir=process.chdir;process.chdir=function(n){cwd=null,chdir.call(process,n)},module.exports=patch;