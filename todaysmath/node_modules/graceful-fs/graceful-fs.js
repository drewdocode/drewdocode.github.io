function noop(){}function patch(e){function t(e,t,n){function r(e,t,n){return y(e,t,function(o){!o||"EMFILE"!==o.code&&"ENFILE"!==o.code?("function"==typeof n&&n.apply(this,arguments),retry()):enqueue([r,[e,t,n]])})}return"function"==typeof t&&(n=t,t=null),r(e,t,n)}function n(e,t,n,r){function o(e,t,n,r){return d(e,t,n,function(u){!u||"EMFILE"!==u.code&&"ENFILE"!==u.code?("function"==typeof r&&r.apply(this,arguments),retry()):enqueue([o,[e,t,n,r]])})}return"function"==typeof n&&(r=n,n=null),o(e,t,n,r)}function r(e,t,n,r){function o(e,t,n,r){return E(e,t,n,function(u){!u||"EMFILE"!==u.code&&"ENFILE"!==u.code?("function"==typeof r&&r.apply(this,arguments),retry()):enqueue([o,[e,t,n,r]])})}return"function"==typeof n&&(r=n,n=null),o(e,t,n,r)}function o(e,t,n){function r(e,t){t&&t.sort&&t.sort(),!e||"EMFILE"!==e.code&&"ENFILE"!==e.code?("function"==typeof n&&n.apply(this,arguments),retry()):enqueue([u,[o]])}var o=[e];return"function"!=typeof t?o.push(t):n=t,o.push(r),u(o)}function u(t){return h.apply(e,t)}function i(e,t){return this instanceof i?(F.apply(this,arguments),this):i.apply(Object.create(i.prototype),arguments)}function c(){var e=this;l(e.path,e.flags,e.mode,function(t,n){t?(e.autoClose&&e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n),e.read())})}function p(e,t){return this instanceof p?(g.apply(this,arguments),this):p.apply(Object.create(p.prototype),arguments)}function f(){var e=this;l(e.path,e.flags,e.mode,function(t,n){t?(e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n))})}function a(e,t){return new i(e,t)}function s(e,t){return new p(e,t)}function l(e,t,n,r){function o(e,t,n,r){return v(e,t,n,function(u,i){!u||"EMFILE"!==u.code&&"ENFILE"!==u.code?("function"==typeof r&&r.apply(this,arguments),retry()):enqueue([o,[e,t,n,r]])})}return"function"==typeof n&&(r=n,n=null),o(e,t,n,r)}polyfills(e),e.gracefulify=patch,e.FileReadStream=i,e.FileWriteStream=p,e.createReadStream=a,e.createWriteStream=s;var y=e.readFile;e.readFile=t;var d=e.writeFile;e.writeFile=n;var E=e.appendFile;E&&(e.appendFile=r);var h=e.readdir;if(e.readdir=o,"v0.8"===process.version.substr(0,4)){var m=legacy(e);i=m.ReadStream,p=m.WriteStream}var F=e.ReadStream;i.prototype=Object.create(F.prototype),i.prototype.open=c;var g=e.WriteStream;p.prototype=Object.create(g.prototype),p.prototype.open=f,e.ReadStream=i,e.WriteStream=p;var v=e.open;return e.open=l,e}function enqueue(e){debug("ENQUEUE",e[0].name,e[1]),queue.push(e)}function retry(){var e=queue.shift();e&&(debug("RETRY",e[0].name,e[1]),e[0].apply(null,e[1]))}var fs=require("fs"),polyfills=require("./polyfills.js"),legacy=require("./legacy-streams.js"),queue=[],util=require("util"),debug=noop;util.debuglog?debug=util.debuglog("gfs4"):/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&(debug=function(){var e=util.format.apply(util,arguments);e="GFS4: "+e.split(/\n/).join("\nGFS4: "),console.error(e)}),/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&process.on("exit",function(){debug(queue),require("assert").equal(queue.length,0)}),module.exports=patch(require("./fs.js")),process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH&&(module.exports=patch(fs)),module.exports.close=fs.close=function(e){return function(t,n){return e.call(fs,t,function(e){e||retry(),"function"==typeof n&&n.apply(this,arguments)})}}(fs.close),module.exports.closeSync=fs.closeSync=function(e){return function(t){var n=e.apply(fs,arguments);return retry(),n}}(fs.closeSync);