/*!
 * node-progress
 * Copyright(c) 2011 TJ Holowaychuk <tj@vision-media.ca>
 * MIT Licensed
 */

function ProgressBar(t,r){if(this.stream=r.stream||process.stderr,"number"==typeof r){var e=r;r={},r.total=e}else{if(r=r||{},"string"!=typeof t)throw new Error("format required");if("number"!=typeof r.total)throw new Error("total required")}this.fmt=t,this.curr=r.curr||0,this.total=r.total,this.width=r.width||this.total,this.clear=r.clear,this.chars={complete:r.complete||"=",incomplete:r.incomplete||"-",head:r.head||r.complete||"="},this.renderThrottle=0!==r.renderThrottle?r.renderThrottle||16:0,this.callback=r.callback||function(){},this.tokens={},this.lastDraw=""}exports=module.exports=ProgressBar,ProgressBar.prototype.tick=function(t,r){if(0!==t&&(t=t||1),"object"==typeof t&&(r=t,t=1),r&&(this.tokens=r),0==this.curr&&(this.start=new Date),this.curr+=t,this.renderThrottleTimeout||(this.renderThrottleTimeout=setTimeout(this.render.bind(this),this.renderThrottle)),this.curr>=this.total)return this.renderThrottleTimeout&&this.render(),this.complete=!0,this.terminate(),void this.callback(this)},ProgressBar.prototype.render=function(t){if(clearTimeout(this.renderThrottleTimeout),this.renderThrottleTimeout=null,t&&(this.tokens=t),this.stream.isTTY){var r=this.curr/this.total;r=Math.min(Math.max(r,0),1);var e,s,i,a=100*r,h=new Date-this.start,o=100==a?0:h*(this.total/this.curr-1),n=this.curr/(h/1e3),l=this.fmt.replace(":current",this.curr).replace(":total",this.total).replace(":elapsed",isNaN(h)?"0.0":(h/1e3).toFixed(1)).replace(":eta",isNaN(o)||!isFinite(o)?"0.0":(o/1e3).toFixed(1)).replace(":percent",a.toFixed(0)+"%").replace(":rate",Math.round(n)),c=Math.max(0,this.stream.columns-l.replace(":bar","").length);c&&"win32"===process.platform&&(c-=1);var m=Math.min(this.width,c);if(i=Math.round(m*r),s=Array(Math.max(0,i+1)).join(this.chars.complete),e=Array(Math.max(0,m-i+1)).join(this.chars.incomplete),i>0&&(s=s.slice(0,-1)+this.chars.head),l=l.replace(":bar",s+e),this.tokens)for(var p in this.tokens)l=l.replace(":"+p,this.tokens[p]);this.lastDraw!==l&&(this.stream.cursorTo(0),this.stream.write(l),this.stream.clearLine(1),this.lastDraw=l)}},ProgressBar.prototype.update=function(t,r){var e=Math.floor(t*this.total),s=e-this.curr;this.tick(s,r)},ProgressBar.prototype.interrupt=function(t){this.stream.clearLine(),this.stream.cursorTo(0),this.stream.write(t),this.stream.write("\n"),this.stream.write(this.lastDraw)},ProgressBar.prototype.terminate=function(){this.clear?this.stream.clearLine&&(this.stream.clearLine(),this.stream.cursorTo(0)):this.stream.write("\n")};