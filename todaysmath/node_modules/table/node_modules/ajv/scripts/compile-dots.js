var glob=require("glob"),fs=require("fs"),path=require("path"),doT=require("dot"),beautify=require("js-beautify").js_beautify,defsRootPath=process.argv[2]||path.join(__dirname,"../lib"),defs={},defFiles=glob.sync("./dot/**/*.def",{cwd:defsRootPath});defFiles.forEach(function(e){var o=path.basename(e,".def");defs[o]=fs.readFileSync(path.join(defsRootPath,e))});var filesRootPath=process.argv[3]||path.join(__dirname,"../lib"),files=glob.sync("./dot/**/*.jst",{cwd:filesRootPath}),dotjsPath=path.join(filesRootPath,"./dotjs");try{fs.mkdirSync(dotjsPath)}catch(e){}console.log("\n\nCompiling:");var FUNCTION_NAME=/function\s+anonymous\s*\(it[^)]*\)\s*{/,OUT_EMPTY_STRING=/out\s*\+=\s*'\s*';/g,ISTANBUL=/'(istanbul[^']+)';/g,ERROR_KEYWORD=/\$errorKeyword/g,ERROR_KEYWORD_OR=/\$errorKeyword\s+\|\|/g,VARS=["$errs","$valid","$lvl","$data","$dataLvl","$errorKeyword","$closingBraces","$schemaPath","$validate"];files.forEach(function(e){function o(e){e=e.replace(/\$/g,"\\$$");var o=new RegExp(e+"[^A-Za-z0-9_$]","g");1==t(o)&&(o=new RegExp("var\\s+"+e+"\\s*=[^;]+;|var\\s+"+e+";"),i=i.replace(o,""))}function t(e){return(i.match(e)||[]).length}var a=path.basename(e,".jst"),r=path.join(dotjsPath,a+".js"),s=fs.readFileSync(path.join(filesRootPath,e)),i=doT.compile(s,defs);i=i.toString().replace(OUT_EMPTY_STRING,"").replace(FUNCTION_NAME,"function generate_"+a+"(it, $keyword, $ruleType) {").replace(ISTANBUL,"/* $1 */"),function(){t(ERROR_KEYWORD)==t(ERROR_KEYWORD_OR)+1&&(i=i.replace(ERROR_KEYWORD_OR,""))}(),VARS.forEach(o),i="'use strict';\nmodule.exports = "+i,i=beautify(i,{indent_size:2})+"\n",fs.writeFileSync(r,i),console.log("compiled",a)});