function compile(e,r,t,o){function a(){var e=b.validate,r=e.apply(null,arguments);return a.errors=e.errors,r}function i(e,t,o,a){var i=!t||t&&t.schema==e;if(t.schema!=r.schema)return compile.call(m,e,t,o,a);var n=!0===e.$async,s=validateGenerator({isTop:!0,schema:e,isRoot:i,baseId:a,root:t,schemaPath:"",errSchemaPath:"#",errorPath:'""',MissingRefError:errorClasses.MissingRef,RULES:_,validate:validateGenerator,util:util,resolve:resolve,resolveRef:l,usePattern:f,useDefault:d,useCustomRule:v,opts:h,formats:E,logger:m.logger,self:m});s=vars(p,refValCode)+vars(y,patternCode)+vars(V,defaultCode)+vars(S,customRuleCode)+s,h.processCode&&(s=h.processCode(s));var c;try{c=new Function("self","RULES","formats","root","refVal","defaults","customRules","equal","ucs2length","ValidationError",s)(m,_,E,r,p,V,S,equal,ucs2length,ValidationError),p[0]=c}catch(e){throw m.logger.error("Error compiling schema, function code:",s),e}return c.schema=e,c.errors=null,c.refs=g,c.refVal=p,c.root=i?c:t,n&&(c.$async=!0),!0===h.sourceCode&&(c.source={code:s,patterns:y,defaults:V}),c}function l(e,o,a){o=resolve.url(e,o);var l,f,d=g[o];if(void 0!==d)return l=p[d],f="refVal["+d+"]",u(l,f);if(!a&&r.refs){var v=r.refs[o];if(void 0!==v)return l=r.refVal[v],f=n(o,l),u(l,f)}f=n(o);var y=resolve.call(m,i,r,o);if(void 0===y){var C=t&&t[o];C&&(y=resolve.inlineRef(C,h.inlineRefs)?C:compile.call(m,C,r,t,e))}if(void 0!==y)return c(o,y),u(y,f);s(o)}function n(e,r){var t=p.length;return p[t]=r,g[e]=t,"refVal"+t}function s(e){delete g[e]}function c(e,r){var t=g[e];p[t]=r}function u(e,r){return"object"==typeof e||"boolean"==typeof e?{code:r,schema:e,inline:!0}:{code:r,$async:e&&!!e.$async}}function f(e){var r=C[e];return void 0===r&&(r=C[e]=y.length,y[r]=e),"pattern"+r}function d(e){switch(typeof e){case"boolean":case"number":return""+e;case"string":return util.toQuotedString(e);case"object":if(null===e)return"null";var r=stableStringify(e),t=R[r];return void 0===t&&(t=R[r]=V.length,V[t]=e),"default"+t}}function v(e,r,t,o){var a=e.definition.validateSchema;if(a&&!1!==m._opts.validateSchema){if(!a(r)){var i="keyword schema is invalid: "+m.errorsText(a.errors);if("log"!=m._opts.validateSchema)throw new Error(i);m.logger.error(i)}}var l,n=e.definition.compile,s=e.definition.inline,c=e.definition.macro;if(n)l=n.call(m,r,t,o);else if(c)l=c.call(m,r,t,o),!1!==h.validateSchema&&m.validateSchema(l,!0);else if(s)l=s.call(m,o,e.keyword,r,t);else if(!(l=e.definition.validate))return;if(void 0===l)throw new Error('custom keyword "'+e.keyword+'"failed to compile');var u=S.length;return S[u]=l,{code:"customRule"+u,validate:l}}var m=this,h=this._opts,p=[void 0],g={},y=[],C={},V=[],R={},S=[];r=r||{schema:e,refVal:p,refs:g};var w=checkCompiling.call(this,e,r,o),b=this._compilations[w.index];if(w.compiling)return b.callValidate=a;var E=this._formats,_=this.RULES;try{var q=i(e,r,t,o);b.validate=q;var x=b.callValidate;return x&&(x.schema=q.schema,x.errors=null,x.refs=q.refs,x.refVal=q.refVal,x.root=q.root,x.$async=q.$async,h.sourceCode&&(x.source=q.source)),q}finally{endCompiling.call(this,e,r,o)}}function checkCompiling(e,r,t){var o=compIndex.call(this,e,r,t);return o>=0?{index:o,compiling:!0}:(o=this._compilations.length,this._compilations[o]={schema:e,root:r,baseId:t},{index:o,compiling:!1})}function endCompiling(e,r,t){var o=compIndex.call(this,e,r,t);o>=0&&this._compilations.splice(o,1)}function compIndex(e,r,t){for(var o=0;o<this._compilations.length;o++){var a=this._compilations[o];if(a.schema==e&&a.root==r&&a.baseId==t)return o}return-1}function patternCode(e,r){return"var pattern"+e+" = new RegExp("+util.toQuotedString(r[e])+");"}function defaultCode(e){return"var default"+e+" = defaults["+e+"];"}function refValCode(e,r){return void 0===r[e]?"":"var refVal"+e+" = refVal["+e+"];"}function customRuleCode(e){return"var customRule"+e+" = customRules["+e+"];"}function vars(e,r){if(!e.length)return"";for(var t="",o=0;o<e.length;o++)t+=r(o,e);return t}var resolve=require("./resolve"),util=require("./util"),errorClasses=require("./error_classes"),stableStringify=require("fast-json-stable-stringify"),validateGenerator=require("../dotjs/validate"),ucs2length=util.ucs2length,equal=require("fast-deep-equal"),ValidationError=errorClasses.Validation;module.exports=compile;