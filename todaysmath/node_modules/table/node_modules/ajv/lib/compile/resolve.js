function resolve(e,r,t){var i=this._refs[t];if("string"==typeof i){if(!this._refs[i])return resolve.call(this,e,r,i);i=this._refs[i]}if((i=i||this._schemas[t])instanceof SchemaObject)return inlineRef(i.schema,this._opts.inlineRefs)?i.schema:i.validate||this._compile(i);var s,o,a,l=resolveSchema.call(this,r,t);return l&&(s=l.schema,r=l.root,a=l.baseId),s instanceof SchemaObject?o=s.validate||e.call(this,s.schema,r,void 0,a):void 0!==s&&(o=inlineRef(s,this._opts.inlineRefs)?s:e.call(this,s,r,void 0,a)),o}function resolveSchema(e,r){var t=url.parse(r,!1,!0),i=_getFullPath(t),s=getFullPath(this._getId(e.schema));if(i!==s){var o=normalizeId(i),a=this._refs[o];if("string"==typeof a)return resolveRecursive.call(this,e,a,t);if(a instanceof SchemaObject)a.validate||this._compile(a),e=a;else{if(!((a=this._schemas[o])instanceof SchemaObject))return;if(a.validate||this._compile(a),o==normalizeId(r))return{schema:a,root:e,baseId:s};e=a}if(!e.schema)return;s=getFullPath(this._getId(e.schema))}return getJsonPointer.call(this,t,s,e.schema,e)}function resolveRecursive(e,r,t){var i=resolveSchema.call(this,e,r);if(i){var s=i.schema,o=i.baseId;e=i.root;var a=this._getId(s);return a&&(o=resolveUrl(o,a)),getJsonPointer.call(this,t,o,s,e)}}function getJsonPointer(e,r,t,i){if(e.hash=e.hash||"","#/"==e.hash.slice(0,2)){for(var s=e.hash.split("/"),o=1;o<s.length;o++){var a=s[o];if(a){if(a=util.unescapeFragment(a),void 0===(t=t[a]))break;var l;if(!PREVENT_SCOPE_CHANGE[a]&&(l=this._getId(t),l&&(r=resolveUrl(r,l)),t.$ref)){var n=resolveUrl(r,t.$ref),h=resolveSchema.call(this,i,n);h&&(t=h.schema,i=h.root,r=h.baseId)}}}return void 0!==t&&t!==i.schema?{schema:t,root:i,baseId:r}:void 0}}function inlineRef(e,r){return!1!==r&&(void 0===r||!0===r?checkNoRef(e):r?countKeys(e)<=r:void 0)}function checkNoRef(e){var r;if(Array.isArray(e)){for(var t=0;t<e.length;t++)if("object"==typeof(r=e[t])&&!checkNoRef(r))return!1}else for(var i in e){if("$ref"==i)return!1;if("object"==typeof(r=e[i])&&!checkNoRef(r))return!1}return!0}function countKeys(e){var r,t=0;if(Array.isArray(e)){for(var i=0;i<e.length;i++)if(r=e[i],"object"==typeof r&&(t+=countKeys(r)),t==1/0)return 1/0}else for(var s in e){if("$ref"==s)return 1/0;if(SIMPLE_INLINED[s])t++;else if(r=e[s],"object"==typeof r&&(t+=countKeys(r)+1),t==1/0)return 1/0}return t}function getFullPath(e,r){return!1!==r&&(e=normalizeId(e)),_getFullPath(url.parse(e,!1,!0))}function _getFullPath(e){var r=e.protocol||"//"==e.href.slice(0,2)?"//":"";return(e.protocol||"")+r+(e.host||"")+(e.path||"")+"#"}function normalizeId(e){return e?e.replace(TRAILING_SLASH_HASH,""):""}function resolveUrl(e,r){return r=normalizeId(r),url.resolve(e,r)}function resolveIds(e){var r=normalizeId(this._getId(e)),t={"":r},i={"":getFullPath(r,!1)},s={},o=this;return traverse(e,{allKeys:!0},function(e,r,a,l,n,h,c){if(""!==r){var f=o._getId(e),u=t[l],m=i[l]+"/"+n;if(void 0!==c&&(m+="/"+("number"==typeof c?c:util.escapeFragment(c))),"string"==typeof f){f=u=normalizeId(u?url.resolve(u,f):f);var v=o._refs[f];if("string"==typeof v&&(v=o._refs[v]),v&&v.schema){if(!equal(e,v.schema))throw new Error('id "'+f+'" resolves to more than one schema')}else if(f!=normalizeId(m))if("#"==f[0]){if(s[f]&&!equal(e,s[f]))throw new Error('id "'+f+'" resolves to more than one schema');s[f]=e}else o._refs[f]=m}t[r]=u,i[r]=m}}),s}var url=require("url"),equal=require("fast-deep-equal"),util=require("./util"),SchemaObject=require("./schema_obj"),traverse=require("json-schema-traverse");module.exports=resolve,resolve.normalizeId=normalizeId,resolve.fullPath=getFullPath,resolve.url=resolveUrl,resolve.ids=resolveIds,resolve.inlineRef=inlineRef,resolve.schema=resolveSchema;var PREVENT_SCOPE_CHANGE=util.toHash(["properties","patternProperties","enum","dependencies","definitions"]),SIMPLE_INLINED=util.toHash(["type","format","pattern","maxLength","minLength","maxProperties","minProperties","maxItems","minItems","maximum","minimum","uniqueItems","multipleOf","required","enum"]),TRAILING_SLASH_HASH=/#\/?$/;